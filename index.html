<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Teklif Oluştur ve Yönet</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .logo {text-align:center; margin-bottom:20px;}
    .logo img {width: 150px;}
    h2 {text-align:center; color:#333; margin-bottom:30px;}
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #output {
      margin-top: 30px;
      min-height: 180px;
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Firebase bağlantı durumu */
    .firebase-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
      z-index: 1000;
    }
    .firebase-connected {
      background-color: #28a745;
      color: white;
    }
    .firebase-disconnected {
      background-color: #dc3545;
      color: white;
    }

    /* Kart stil */
    .card-container {
      margin-top: 15px;
    }
    .card {
      background: #fff;
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card h3 {
      margin-top: 0;
      color: #007bff;
    }
    .card p {
      margin: 6px 0;
      color: #333;
    }
    .card button {
      margin-right: 10px;
      margin-top: 10px;
      width: auto;
      padding: 6px 14px;
      font-size: 14px;
    }

    /* Accordion Menü */
    .accordion {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      padding: 15px 20px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      border-radius: 8px;
      margin-top: 25px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .accordion:hover {
      background-color: #0056b3;
    }
    .accordion.active {
      background-color: #00408d;
    }
    .panel {
      padding: 0 20px 15px 20px;
      display: none;
      background-color: white;
      overflow: hidden;
      border: 1px solid #007bff;
      border-top: none;
      border-radius: 0 0 8px 8px;
    }

    /* Edit form styles */
    #editForm {
      background: #eef5ff;
      border: 2px solid #0056b3;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    #editForm label {
      font-weight: bold;
      margin-top: 5px;
    }
    #editForm button {
      width: 48%;
      margin-top: 10px;
    }
    #editForm .btn-cancel {
      background-color: #dc3545;
    }
    #editForm .btn-cancel:hover {
      background-color: #a71d2a;
    }

    /* PDF için özel stiller */
    .pdf-content {
      background: white;
      padding: 40px;
      margin: 20px;
      border: 1px solid #ddd;
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
    }
    
    .pdf-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 20px;
    }
    
    .pdf-header img {
      max-height: 80px;
      margin-bottom: 15px;
    }
    
    .pdf-title {
      color: #007bff;
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    
    .pdf-body {
      font-size: 16px;
    }
    
    .pdf-body p {
      margin: 12px 0;
    }
    
    .pdf-body strong {
      color: #007bff;
    }
    
    .pdf-footer {
      margin-top: 40px;
      text-align: center;
      font-size: 14px;
      color: #666;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }

    /* Yazdır için gizle */
    @media print {
      body * {
        visibility: hidden;
      }
      .pdf-content, .pdf-content * {
        visibility: visible;
      }
      .pdf-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Firebase bağlantı durumu -->
  <div id="firebaseStatus" class="firebase-status firebase-disconnected">
    🔴 Firebase Bağlanıyor...
  </div>

  <div class="container">
    <div class="logo">
      <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
    </div>
    <h2>TEKLİF OLUŞTUR</h2>

    <label>Müşteri Adı</label>
    <input type="text" id="ad" />

    <label>Çekim Türü</label>
    <input type="text" id="cekim" placeholder="Örn: Düğün, Save the Date, Ürün" />

    <label>Paket Seçimi</label>
    <select id="paket" onchange="paketBilgisiYukle()">
      <option value="">-- Paket Seçin --</option>
      <option value="bronze">Bronze</option>
      <option value="silver">Silver</option>
      <option value="gold">Gold</option>
    </select>

    <label>Etkinlik Yeri</label>
    <input type="text" id="yer" placeholder="Örn: İstanbul, Kemerburgaz Ormanı" />

    <label>Tarih</label>
    <input type="date" id="tarih" />

    <label>Fiyat (TL)</label>
    <input type="number" id="fiyat" />

    <label>Açıklama</label>
    <textarea id="aciklama" rows="3" placeholder="Detaylar..."></textarea>

    <label>Referans Kişi</label>
    <input type="text" id="referans" placeholder="Seni öneren kişi (isteğe bağlı)" />

    <button onclick="teklifHazirla()" id="teklifBtn">TEKLİFİ OLUŞTUR</button>

    <div id="output"></div>

    <button class="accordion">Teklifler</button>
    <div class="panel" id="tekliflerPanel">
      <div id="tekliflerListesi" class="card-container"></div>
    </div>

    <button class="accordion">Sözleşmeler</button>
    <div class="panel" id="sozlesmelerPanel">
      <div id="sozlesmelerListesi" class="card-container"></div>
    </div>

    <!-- Düzenleme Formu (gizli) -->
    <div id="editForm" style="display:none;">
      <h3>Teklifi Düzenle</h3>
      <label>Müşteri Adı</label>
      <input type="text" id="editAd" />

      <label>Çekim Türü</label>
      <input type="text" id="editCekim" placeholder="Örn: Düğün, Save the Date, Ürün" />

      <label>Paket Seçimi</label>
      <select id="editPaket" onchange="editPaketBilgisiYukle()">
        <option value="">-- Paket Seçin --</option>
        <option value="bronze">Bronze</option>
        <option value="silver">Silver</option>
        <option value="gold">Gold</option>
      </select>

      <label>Etkinlik Yeri</label>
      <input type="text" id="editYer" placeholder="Örn: İstanbul, Kemerburgaz Ormanı" />

      <label>Tarih</label>
      <input type="date" id="editTarih" />

      <label>Fiyat (TL)</label>
      <input type="number" id="editFiyat" />

      <label>Açıklama</label>
      <textarea id="editAciklama" rows="3" placeholder="Detaylar..."></textarea>

      <label>Referans Kişi</label>
      <input type="text" id="editReferans" placeholder="Seni öneren kişi (isteğe bağlı)" />

      <button onclick="kaydetDuzenleme()">Kaydet</button>
      <button class="btn-cancel" onclick="iptalDuzenleme()">İptal</button>
    </div>
  </div>

  <!-- PDF içeriği için gizli div -->
  <div id="pdfContent" class="pdf-content" style="display:none;">
    <!-- PDF içeriği buraya dinamik olarak eklenecek -->
  </div>

  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

<script>
  // Firebase Configuration - Bu kısmı kendi Firebase projenizin bilgileriyle değiştirin
       const firebaseConfig = {
            apiKey: "AIzaSyDMMpU1l8zabgaw7bfSHKCOxLbz-RhNT7I",
            authDomain: "databasepsv-dc1b7.firebaseapp.com",
            databaseURL: "https://databasepsv-dc1b7-default-rtdb.firebaseio.com",
            projectId: "databasepsv-dc1b7",
            storageBucket: "databasepsv-dc1b7.firebasestorage.app",
            messagingSenderId: "106474799557",
            appId: "1:106474799557:web:8f7cff2b7ef8466ab08bac",
            measurementId: "G-BKKE9YZS1T"
        };

  // Firebase'i başlat
  let db;
  let firebaseConnected = false;

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseConnected = true;
    updateFirebaseStatus(true);
    console.log("Firebase başarıyla bağlandı!");
  } catch (error) {
    console.error("Firebase bağlantı hatası:", error);
    updateFirebaseStatus(false);
    // Firebase bağlantısı yoksa yerel depolama kullan
    alert("Firebase bağlantısı kurulamadı. Veriler geçici olarak tarayıcıda saklanacak.");
  }

  function updateFirebaseStatus(connected) {
    const statusEl = document.getElementById('firebaseStatus');
    if (connected) {
      statusEl.textContent = '🟢 Firebase Bağlı';
      statusEl.className = 'firebase-status firebase-connected';
    } else {
      statusEl.textContent = '🔴 Firebase Bağlantısız';
      statusEl.className = 'firebase-status firebase-disconnected';
    }
  }

  const paketler = {
    bronze: {
      fiyat: 3000,
      aciklama: "2 saat çekim, 30 düzenlenmiş fotoğraf, 1 dakikalık reels"
    },
    silver: {
      fiyat: 5000,
      aciklama: "4 saat çekim, 60 düzenlenmiş fotoğraf, 2 dakikalık klip"
    },
    gold: {
      fiyat: 8000,
      aciklama: "Tüm gün çekim, 100+ fotoğraf, drone + 3 dakikalık klip"
    }
  };

  let teklifler = [];
  let sozlesmeler = [];
  let duzenlenenTeklifId = null;

  // Sayfa yüklendiğinde verileri çek
  window.addEventListener('load', async () => {
    await veriCek();
  });

  // Firebase'den verileri çek
  async function veriCek() {
    if (!firebaseConnected) {
      console.log("Firebase bağlantısı yok, yerel veriler kullanılıyor.");
      return;
    }

    try {
      showLoading("tekliflerListesi");
      showLoading("sozlesmelerListesi");

      // Teklifleri çek
      const teklifSnapshot = await db.collection('teklifler').orderBy('createdAt', 'desc').get();
      teklifler = [];
      teklifSnapshot.forEach(doc => {
        teklifler.push({
          id: doc.id,
          ...doc.data()
        });
      });

      // Sözleşmeleri çek
      const sozlesmeSnapshot = await db.collection('sozlesmeler').orderBy('createdAt', 'desc').get();
      sozlesmeler = [];
      sozlesmeSnapshot.forEach(doc => {
        sozlesmeler.push({
          id: doc.id,
          ...doc.data()
        });
      });

      renderTeklifler();
      renderSozlesmeler();
    } catch (error) {
      console.error("Veri çekme hatası:", error);
      document.getElementById('output').innerHTML = `
        <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px;">
          ❌ Veriler yüklenirken hata oluştu: ${error.message}
        </div>
      `;
    }
  }

  function showLoading(containerId) {
    document.getElementById(containerId).innerHTML = `
      <div class="loading-text">
        <div class="loading"></div>
        Veriler yükleniyor...
      </div>
    `;
  }

  // Accordion aç/kapa
  document.querySelectorAll(".accordion").forEach(button => {
    button.addEventListener("click", () => {
      button.classList.toggle("active");
      const panel = button.nextElementSibling;
      if(panel.style.display === "block") {
        panel.style.display = "none";
      } else {
        panel.style.display = "block";
      }
    });
  });

  function paketBilgisiYukle() {
    const secilen = document.getElementById("paket").value;
    if (paketler[secilen]) {
      document.getElementById("fiyat").value = paketler[secilen].fiyat;
      document.getElementById("aciklama").value = paketler[secilen].aciklama;
    }
  }

  function editPaketBilgisiYukle() {
    const secilen = document.getElementById("editPaket").value;
    if (paketler[secilen]) {
      document.getElementById("editFiyat").value = paketler[secilen].fiyat;
      document.getElementById("editAciklama").value = paketler[secilen].aciklama;
    }
  }

  async function teklifHazirla() {
    const ad = document.getElementById("ad").value.trim();
    if (!ad) {
      alert("Müşteri adı boş bırakılamaz!");
      return;
    }

    const btn = document.getElementById("teklifBtn");
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Teklif Oluşturuluyor...';

    const cekim = document.getElementById("cekim").value
      .split(',')
      .map(c => c.trim())
      .filter(Boolean)
      .map(c => `- ${c}`)
      .join('<br>');
    const paket = document.getElementById("paket").value.toUpperCase();
    const yer = document.getElementById("yer").value;
    const tarih = document.getElementById("tarih").value;
    const fiyat = document.getElementById("fiyat").value;
    const aciklama = document.getElementById("aciklama").value.replace(/\n/g, '<br>');
    const referans = document.getElementById("referans").value;
    const bugun = new Date().toLocaleDateString('tr-TR');

    const teklif = {
      ad, cekim, paket, yer, tarih, fiyat, aciklama, referans, bugun,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      if (firebaseConnected) {
        // Firebase'e kaydet
        const docRef = await db.collection('teklifler').add(teklif);
        teklif.id = docRef.id;
      } else {
        // Yerel olarak kaydet
        teklif.id = Date.now().toString();
      }
      
      teklifler.unshift(teklif);
      renderTeklifler();

      document.getElementById("output").innerHTML = `
        <div style="color: green; padding: 10px; border: 1px solid green; border-radius: 5px;">
          ✅ Teklif başarıyla oluşturuldu!
        </div>
      `;

      // Formu temizle
      ["ad", "cekim", "paket", "yer", "tarih", "fiyat", "aciklama", "referans"].forEach(id => {
        document.getElementById(id).value = "";
      });

    } catch (error) {
      console.error("Teklif kaydetme hatası:", error);
      document.getElementById("output").innerHTML = `
        <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px;">
          ❌ Teklif kaydedilirken hata oluştu: ${error.message}
        </div>
      `;
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'TEKLİFİ OLUŞTUR';
    }
  }

  function renderTeklifler() {
    const container = document.getElementById("tekliflerListesi");
    
    if (teklifler.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Henüz teklif bulunmamaktadır.</p>';
      return;
    }

    container.innerHTML = "";
    teklifler.forEach(teklif => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <h3>${teklif.ad}</h3>
        <p><strong>Çekim Türü:</strong><br>${teklif.cekim}</p>
        <p><strong>Paket:</strong> ${teklif.paket}</p>
        <p><strong>Etkinlik Yeri:</strong> ${teklif.yer}</p>
        <p><strong>Tarih:</strong> ${teklif.tarih}</p>
        <p><strong>Fiyat:</strong> ${teklif.fiyat} TL</p>
        <button onclick="teklifiGoster('${teklif.id}')">Teklifi Göster</button>
        <button onclick="pdfOlusturVePaylas('${teklif.id}')">PDF Kaydet ve Paylaş</button>
        <button onclick="teklifiDuzenle('${teklif.id}')">Düzenle</button>
        <button onclick="teklifiKabulEt('${teklif.id}')">Sözleşmeye Dönüştür</button>
      `;

      container.appendChild(card);
    });
  }

  function teklifiGoster(id) {
    const teklif = teklifler.find(t => t.id === id);
    if (!teklif) return alert("Teklif bulunamadı.");

    const html = `
      <div style="border:2px solid #007bff; padding:20px; border-radius:10px; max-width:700px; margin:auto; background:#fff;">
        <div style="text-align:center; margin-bottom:20px;">
          <img src='https://i.hizliresim.com/eqyhuxx.png' style="max-height:80px;">
          <h2 style="color:#007bff; margin:10px 0;">📸 FOTOĞRAFÇILIK HİZMET TEKLİFİ</h2>
        </div>
        <div style="font-size:16px; color:#333; line-height:1.6;">
          <p><strong>👤 Müşteri:</strong> ${teklif.ad}</p>
          <p><strong>📷 Çekim Türü:</strong><br>${teklif.cekim}</p>
          <p><strong>📦 Paket:</strong> ${teklif.paket}</p>
          <p><strong>📍 Etkinlik Yeri:</strong> ${teklif.yer}</p>
          <p><strong>📅 Tarih:</strong> ${teklif.tarih}</p>
          <p><strong>💰 Fiyat:</strong> ${teklif.fiyat} TL</p>
          <p><strong>📝 Açıklama:</strong><br>${teklif.aciklama}</p>
          ${teklif.referans && teklif.referans.trim() !== "" ? `<p><strong>👥 Referans:</strong> ${teklif.referans}</p>` : ""}
        </div>
        <div style="margin-top:30px; text-align:center; font-size:14px; color:#666;">
          Bu teklif <strong>${teklif.bugun}</strong> tarihinde hazırlanmıştır.<br>
          Fotoğrafçı: <strong>PASOVART</strong> | Tüm hakları saklıdır.
        </div>
      </div>
    `;
    document.getElementById("output").innerHTML = html;
  }

  function pdfOlusturVePaylas(id) {
    const teklif = teklifler.find(t => t.id === id);
    if (!teklif) return alert("Teklif bulunamadı.");

    // PDF içeriğini hazırla
    const pdfContent = document.getElementById("pdfContent");
    pdfContent.innerHTML = `
      <div class="pdf-header">
        <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo">
        <h1 class="pdf-title">📸 FOTOĞRAFÇILIK HİZMET TEKLİFİ</h1>
      </div>
      <div class="pdf-body">
        <p><strong>👤 Müşteri:</strong> ${teklif.ad}</p>
        <p><strong>📷 Çekim Türü:</strong><br>${teklif.cekim}</p>
        <p><strong>📦 Paket:</strong> ${teklif.paket}</p>
        <p><strong>📍 Etkinlik Yeri:</strong> ${teklif.yer}</p>
        <p><strong>📅 Tarih:</strong> ${teklif.tarih}</p>
        <p><strong>💰 Fiyat:</strong> ${teklif.fiyat} TL</p>
        <p><strong>📝 Açıklama:</strong><br>${teklif.aciklama}</p>
        ${teklif.referans && teklif.referans.trim() !== "" ? `<p><strong>👥 Referans:</strong> ${teklif.referans}</p>` : ""}
      </div>
      <div class="pdf-footer">
        <p>Bu teklif <strong>${teklif.bugun}</strong> tarihinde hazırlanmıştır.</p>
        <p>Fotoğrafçı: <strong>PASOVART</strong> | Tüm hakları saklıdır.</p>
      </div>
    `;

    // PDF'i göster ve yazdır menüsünü aç
    pdfContent.style.display = "block";
    
    // Kısa bir süre bekle ki içerik yüklensin
    setTimeout(() => {
      window.print();
      
      // Yazdırdıktan sonra WhatsApp paylaşımını sor
      setTimeout(() => {
        pdfContent.style.display = "none";
        
        if (confirm("PDF kaydedildi! Şimdi WhatsApp'ta paylaşmak ister misiniz?")) {
          whatsappPaylas(id);
        }
      }, 1000);
    }, 500);
  }

  function whatsappPaylas(id) {
    const teklif = teklifler.find(t => t.id === id);
    if (!teklif) return alert("Teklif bulunamadı.");
    
    // WhatsApp mesaj metni hazırlama
    let mesaj = `📸 Fotoğrafçılık Hizmet Teklifi\n\n`;
    mesaj += `Müşteri: ${teklif.ad}\n`;
    mesaj += `Çekim Türü: ${teklif.cekim.replace(/<br>/g, ', ').replace(/- /g,'')}\n`;
    mesaj += `Paket: ${teklif.paket}\n`;
    mesaj += `Etkinlik Yeri: ${teklif.yer}\n`;
    mesaj += `Tarih: ${teklif.tarih}\n`;
    mesaj += `Fiyat: ${teklif.fiyat} TL\n`;
    mesaj += `Açıklama: ${teklif.aciklama.replace(/<br>/g, '\n')}\n`;
    if (teklif.referans && teklif.referans.trim() !== "") {
      mesaj += `Referans: ${teklif.referans}\n`;
    }
    mesaj += `\n📄 Detaylı teklif PDF'i ekte gönderilmiştir.\n\nFotoğrafçı: Ferdi Kabalı`;

    const url = `https://wa.me/?text=${encodeURIComponent(mesaj)}`;
    window.open(url, '_blank');
  }

function teklifiDuzenle(id) {
    const teklif = teklifler.find(t => t.id === id);
    if(!teklif) return alert("Teklif bulunamadı.");

    duzenlenenTeklifId = id;

    // Açık panel varsa kapat (opsiyonel)
    document.getElementById("output").innerHTML = "";

    // Düzenleme formunu göster ve alanları doldur
    document.getElementById("editAd").value = teklif.ad;
    document.getElementById("editCekim").value = teklif.cekim.replace(/- /g, '').replace(/<br>/g, ', ');
    document.getElementById("editPaket").value = teklif.paket.toLowerCase();
    document.getElementById("editYer").value = teklif.yer;
    document.getElementById("editTarih").value = teklif.tarih;
    document.getElementById("editFiyat").value = teklif.fiyat;
    document.getElementById("editAciklama").value = teklif.aciklama.replace(/<br>/g, '\n');
    document.getElementById("editReferans").value = teklif.referans || '';

    document.getElementById("editForm").style.display = "block";
    window.scrollTo({top: 0, behavior: 'smooth'});
}

async function kaydetDuzenleme() {
    if(duzenlenenTeklifId === null) return;

    const ad = document.getElementById("editAd").value.trim();
    if (!ad) {
        alert("Müşteri adı boş bırakılamaz!");
        return;
    }

    const cekim = document.getElementById("editCekim").value.trim();
    const paket = document.getElementById("editPaket").value;
    const yer = document.getElementById("editYer").value.trim();
    const tarih = document.getElementById("editTarih").value;
    const fiyat = document.getElementById("editFiyat").value.trim();
    const aciklama = document.getElementById("editAciklama").value.trim();
    const referans = document.getElementById("editReferans").value.trim();

    // Gerekli alanları kontrol et
    if (!cekim || !paket || !yer || !tarih || !fiyat) {
        alert("Lütfen tüm gerekli alanları doldurun!");
        return;
    }

    // Fiyat formatını kontrol et
    if (isNaN(fiyat) || parseFloat(fiyat) <= 0) {
        alert("Lütfen geçerli bir fiyat girin!");
        return;
    }

    // Çekim listesini formatla
    const cekimFormatli = cekim.split(',')
        .map(item => item.trim())
        .filter(item => item)
        .map(item => `- ${item}`)
        .join('<br>');

    // Açıklamayı formatla
    const aciklamaFormatli = aciklama.replace(/\n/g, '<br>');

    // Teklifi güncelle
    const teklifIndex = teklifler.findIndex(t => t.id === duzenlenenTeklifId);
    if (teklifIndex !== -1) {
        teklifler[teklifIndex] = {
            ...teklifler[teklifIndex],
            ad: ad,
            cekim: cekimFormatli,
            paket: paket,
            yer: yer,
            tarih: tarih,
            fiyat: parseFloat(fiyat),
            aciklama: aciklamaFormatli,
            referans: referans
        };

        // Yerel depolamaya kaydet (eğer kullanılıyorsa)
        try {
            localStorage.setItem('teklifler', JSON.stringify(teklifler));
        } catch (error) {
            console.warn('Yerel depolamaya kaydedilemedi:', error);
        }

        alert("Teklif başarıyla güncellendi!");
        
        // Formu temizle ve gizle
        duzenlemeIptal();
        
        // Teklif listesini yeniden yükle (eğer bir liste görünümü varsa)
        if (typeof teklifleriListele === 'function') {
            teklifleriListele();
        }
    } else {
        alert("Teklif güncellenirken bir hata oluştu!");
    }
}

function duzenlemeIptal() {
    // Formu gizle
    document.getElementById("editForm").style.display = "none";
    
    // Form alanlarını temizle
    document.getElementById("editAd").value = "";
    document.getElementById("editCekim").value = "";
    document.getElementById("editPaket").value = "";
    document.getElementById("editYer").value = "";
    document.getElementById("editTarih").value = "";
    document.getElementById("editFiyat").value = "";
    document.getElementById("editAciklama").value = "";
    document.getElementById("editReferans").value = "";
    
    // Düzenlenen teklif ID'sini sıfırla
    duzenlenenTeklifId = null;
}

// Teklif silme fonksiyonu
function teklifiSil(id) {
    if (!confirm("Bu teklifi silmek istediğinizden emin misiniz?")) {
        return;
    }

    const teklifIndex = teklifler.findIndex(t => t.id === id);
    if (teklifIndex !== -1) {
        teklifler.splice(teklifIndex, 1);
        
        // Yerel depolamayı güncelle
        try {
            localStorage.setItem('teklifler', JSON.stringify(teklifler));
        } catch (error) {
            console.warn('Yerel depolamaya kaydedilemedi:', error);
        }

        alert("Teklif başarıyla silindi!");
        
        // Teklif listesini yeniden yükle
        if (typeof teklifleriListele === 'function') {
            teklifleriListele();
        }
    } else {
        alert("Teklif silinirken bir hata oluştu!");
    }
}

// Teklif görüntüleme fonksiyonu
function teklifiGoruntule(id) {
    const teklif = teklifler.find(t => t.id === id);
    if (!teklif) {
        alert("Teklif bulunamadı.");
        return;
    }

    const outputDiv = document.getElementById("output");
    
    const html = `
        <div class="teklif-detay">
            <h3>Teklif Detayı</h3>
            <div class="teklif-bilgi">
                <p><strong>Müşteri Adı:</strong> ${teklif.ad}</p>
                <p><strong>Çekim Türü:</strong></p>
                <div class="cekim-listesi">${teklif.cekim}</div>
                <p><strong>Paket:</strong> ${teklif.paket.toUpperCase()}</p>
                <p><strong>Mekan:</strong> ${teklif.yer}</p>
                <p><strong>Tarih:</strong> ${teklif.tarih}</p>
                <p><strong>Fiyat:</strong> ${teklif.fiyat} TL</p>
                ${teklif.aciklama ? `<p><strong>Açıklama:</strong></p><div class="aciklama">${teklif.aciklama}</div>` : ''}
                ${teklif.referans ? `<p><strong>Referans:</strong> ${teklif.referans}</p>` : ''}
            </div>
            <div class="teklif-aksiyonlar">
                <button onclick="teklifiDuzenle(${teklif.id})" class="btn-duzenle">Düzenle</button>
                <button onclick="teklifiSil(${teklif.id})" class="btn-sil">Sil</button>
                <button onclick="teklifiKopyala(${teklif.id})" class="btn-kopyala">Kopyala</button>
                <button onclick="teklifiPDF(${teklif.id})" class="btn-pdf">PDF İndir</button>
            </div>
        </div>
    `;
    
    outputDiv.innerHTML = html;
    outputDiv.scrollIntoView({ behavior: 'smooth' });
}

// Teklif kopyalama fonksiyonu
function teklifiKopyala(id) {
    const teklif = teklifler.find(t => t.id === id);
    if (!teklif) {
        alert("Teklif bulunamadı.");
        return;
    }

    // Yeni ID oluştur
    const yeniId = Math.max(...teklifler.map(t => t.id)) + 1;
    
    // Teklifi kopyala
    const yeniTeklif = {
        ...teklif,
        id: yeniId,
        ad: teklif.ad + " (Kopya)",
        tarih: new Date().toISOString().split('T')[0] // Bugünün tarihi
    };

    teklifler.push(yeniTeklif);

    // Yerel depolamayı güncelle
    try {
        localStorage.setItem('teklifler', JSON.stringify(teklifler));
    } catch (error) {
        console.warn('Yerel depolamaya kaydedilemedi:', error);
    }

    alert("Teklif başarıyla kopyalandı!");
    
    // Teklif listesini yenile
    if (typeof teklifleriListele === 'function') {
        teklifleriListele();
    }
}

// Teklif PDF çıktısı fonksiyonu
function teklifiPDF(id) {
    const teklif = teklifler.find(t => t.id === id);
    if (!teklif) {
        alert("Teklif bulunamadı.");
        return;
    }

    // Basit PDF içeriği oluştur (window.print kullanarak)
    const pdfWindow = window.open('', '_blank');
    const pdfContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Teklif - ${teklif.ad}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .teklif-info { margin-bottom: 20px; }
                .teklif-info p { margin: 5px 0; }
                .cekim-listesi { margin-left: 20px; }
                .fiyat { font-size: 18px; font-weight: bold; color: #2c5530; }
                @media print { button { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Fotoğraf Çekim Teklifi</h1>
                <hr>
            </div>
            <div class="teklif-info">
                <p><strong>Müşteri Adı:</strong> ${teklif.ad}</p>
                <p><strong>Çekim Türü:</strong></p>
                <div class="cekim-listesi">${teklif.cekim}</div>
                <p><strong>Paket:</strong> ${teklif.paket.toUpperCase()}</p>
                <p><strong>Mekan:</strong> ${teklif.yer}</p>
                <p><strong>Tarih:</strong> ${teklif.tarih}</p>
                <p class="fiyat"><strong>Fiyat:</strong> ${teklif.fiyat} TL</p>
                ${teklif.aciklama ? `<p><strong>Açıklama:</strong></p><div>${teklif.aciklama}</div>` : ''}
                ${teklif.referans ? `<p><strong>Referans:</strong> ${teklif.referans}</p>` : ''}
            </div>
            <div style="margin-top: 50px;">
                <p><strong>Tarih:</strong> ${new Date().toLocaleDateString('tr-TR')}</p>
                <p><strong>İmza:</strong> _________________</p>
            </div>
            <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px;">Yazdır</button>
        </body>
        </html>
    `;

    pdfWindow.document.write(pdfContent);
    pdfWindow.document.close();
}

// Teklif arama fonksiyonu
function teklifAra(aramaMetni) {
    if (!aramaMetni.trim()) {
        return teklifler;
    }

    const aramaTerimi = aramaMetni.toLowerCase();
    return teklifler.filter(teklif => 
        teklif.ad.toLowerCase().includes(aramaTerimi) ||
        teklif.yer.toLowerCase().includes(aramaTerimi) ||
        teklif.paket.toLowerCase().includes(aramaTerimi) ||
        teklif.cekim.toLowerCase().includes(aramaTerimi) ||
        (teklif.aciklama && teklif.aciklama.toLowerCase().includes(aramaTerimi)) ||
        (teklif.referans && teklif.referans.toLowerCase().includes(aramaTerimi))
    );
}

// Teklifleri sıralama fonksiyonu
function teklifleriSirala(siralama) {
    switch(siralama) {
        case 'ad':
            return [...teklifler].sort((a, b) => a.ad.localeCompare(b.ad));
        case 'tarih':
            return [...teklifler].sort((a, b) => new Date(b.tarih) - new Date(a.tarih));
        case 'fiyat':
            return [...teklifler].sort((a, b) => b.fiyat - a.fiyat);
        case 'paket':
            return [...teklifler].sort((a, b) => a.paket.localeCompare(b.paket));
        default:
            return teklifler;
    }
}

// Yerel depolamadan teklifleri yükle
function teklifleriYukle() {
    try {
        const kaydedilmisler = localStorage.getItem('teklifler');
        if (kaydedilmisler) {
            teklifler = JSON.parse(kaydedilmisler);
        }
    } catch (error) {
        console.error('Teklifler yüklenirken hata:', error);
        teklifler = [];
    }
}

// Teklifleri listele fonksiyonu
function teklifleriListele() {
    const liste = document.getElementById('teklifListesi');
    if (!liste) return;

    if (teklifler.length === 0) {
        liste.innerHTML = '<p>Henüz teklif bulunmuyor.</p>';
        return;
    }

    let html = '<div class="teklif-liste">';
    teklifler.forEach(teklif => {
        html += `
            <div class="teklif-kart" data-id="${teklif.id}">
                <div class="teklif-baslik">
                    <h4>${teklif.ad}</h4>
                    <span class="fiyat">${teklif.fiyat} TL</span>
                </div>
                <div class="teklif-ozet">
                    <p><strong>Paket:</strong> ${teklif.paket.toUpperCase()}</p>
                    <p><strong>Mekan:</strong> ${teklif.yer}</p>
                    <p><strong>Tarih:</strong> ${teklif.tarih}</p>
                </div>
                <div class="teklif-aksiyonlar">
                    <button onclick="teklifiGoruntule(${teklif.id})" class="btn btn-info">Görüntüle</button>
                    <button onclick="teklifiDuzenle(${teklif.id})" class="btn btn-warning">Düzenle</button>
                    <button onclick="teklifiSil(${teklif.id})" class="btn btn-danger">Sil</button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    liste.innerHTML = html;
}

// Sözleşmeleri render etme fonksiyonu (hata düzeltmesi için)
function renderSozlesmeler() {
    // Bu fonksiyon başka bir modülde tanımlı olabilir
    // Şimdilik teklifleri listele
    teklifleriListele();
}

// Yeni teklif ekleme fonksiyonu
function yeniTeklifEkle(teklifData) {
    // Yeni ID oluştur
    const yeniId = teklifler.length > 0 ? Math.max(...teklifler.map(t => t.id)) + 1 : 1;
    
    const yeniTeklif = {
        id: yeniId,
        ad: teklifData.ad,
        cekim: teklifData.cekim,
        paket: teklifData.paket,
        yer: teklifData.yer,
        tarih: teklifData.tarih,
        fiyat: parseFloat(teklifData.fiyat),
        aciklama: teklifData.aciklama || '',
        referans: teklifData.referans || '',
        olusturmaTarihi: new Date().toISOString()
    };

    teklifler.push(yeniTeklif);

    // Yerel depolamaya kaydet
    try {
        localStorage.setItem('teklifler', JSON.stringify(teklifler));
    } catch (error) {
        console.warn('Yerel depolamaya kaydedilemedi:', error);
    }

    // Listeyi güncelle
    teklifleriListele();
    
    return yeniTeklif;
}

// Arama fonksiyonunu kullanma
function aramaYap() {
    const aramaInput = document.getElementById('aramaInput');
    if (!aramaInput) return;

    const aramaMetni = aramaInput.value.trim();
    const sonuclar = teklifAra(aramaMetni);
    
    // Geçici olarak sonuçları göster
    const eskiTeklifler = [...teklifler];
    teklifler.length = 0;
    teklifler.push(...sonuclar);
    
    teklifleriListele();
    
    // Orijinal listeyi geri yükle
    setTimeout(() => {
        teklifler.length = 0;
        teklifler.push(...eskiTeklifler);
    }, 100);
}

// Sıralama fonksiyonunu kullanma
function siralamaYap(tur) {
    const siraliTeklifler = teklifleriSirala(tur);
    const eskiTeklifler = [...teklifler];
    
    teklifler.length = 0;
    teklifler.push(...siraliTeklifler);
    
    teklifleriListele();
}

// Verileri dışa aktarma
function verileriDısaAktar() {
    const dataStr = JSON.stringify(teklifler, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `teklifler_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

// Verileri içe aktarma
function verileriIceAktar(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
                teklifler.length = 0;
                teklifler.push(...data);
                
                localStorage.setItem('teklifler', JSON.stringify(teklifler));
                teklifleriListele();
                alert('Veriler başarıyla içe aktarıldı!');
            } else {
                alert('Geçersiz dosya formatı!');
            }
        } catch (error) {
            alert('Dosya okuma hatası: ' + error.message);
        }
    };
    reader.readAsText(file);
}

// Global değişkenleri başlat
if (typeof teklifler === 'undefined') {
    window.teklifler = [];
}
if (typeof duzenlenenTeklifId === 'undefined') {
    window.duzenlenenTeklifId = null;
}

// Sayfa yüklendiğinde teklifleri yükle
document.addEventListener('DOMContentLoaded', function() {
    teklifleriYukle();
    teklifleriListele();
    
    // Arama input'u varsa event listener ekle
    const aramaInput = document.getElementById('aramaInput');
    if (aramaInput) {
        aramaInput.addEventListener('input', aramaYap);
    }
});

</script>

</body>
</html>
