<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Teklif Oluştur ve Yönet</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .logo {text-align:center; margin-bottom:20px;}
    .logo img {width: 150px;}
    h2 {text-align:center; color:#333; margin-bottom:30px;}
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #output {
      margin-top: 30px;
      min-height: 180px;
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Firebase ve Google Calendar bağlantı durumu */
    .status-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    .status-item {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .status-connected {
      background-color: #28a745;
      color: white;
    }
    .status-disconnected {
      background-color: #dc3545;
      color: white;
    }
    .status-warning {
      background-color: #ffc107;
      color: #212529;
    }

    /* Calendar Auth Button */
    .calendar-auth {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .calendar-auth:hover {
      background-color: #3367d6;
    }

    /* Yeni Liste Tasarımı */
    .search-container {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #007bff;
      border-radius: 5px;
      font-size: 14px;
    }
    .search-btn {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: auto;
    }
    .clear-btn {
      padding: 10px 15px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: auto;
    }

    .list-container {
      background: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }
    .list-header {
      background: #007bff;
      color: white;
      padding: 15px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 150px;
      gap: 10px;
      font-weight: bold;
      font-size: 14px;
    }
    .list-item {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 150px;
      gap: 10px;
      align-items: center;
      background: white;
      transition: background-color 0.2s;
      font-size: 14px;
    }
    .list-item:hover {
      background-color: #f8f9fa;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-actions {
      display: flex;
      gap: 5px;
    }
    .list-actions button {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 3px;
      width: auto;
      margin: 0;
    }
    .btn-view { background: #17a2b8; }
    .btn-edit { background: #ffc107; color: #212529; }
    .btn-delete { background: #dc3545; }
    .btn-contract { background: #28a745; }
    .btn-pdf { background: #6c757d; }
    .btn-calendar { background: #4285f4; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }

    /* Accordion Menü */
    .accordion {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      padding: 15px 20px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      border-radius: 8px;
      margin-top: 25px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .accordion:hover {
      background-color: #0056b3;
    }
    .accordion.active {
      background-color: #00408d;
    }
    .panel {
      padding: 0;
      display: none;
      background-color: white;
      overflow: hidden;
      border: 1px solid #007bff;
      border-top: none;
      border-radius: 0 0 8px 8px;
    }

    /* Edit form styles */
    #editForm {
      background: #eef5ff;
      border: 2px solid #0056b3;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    #editForm label {
      font-weight: bold;
      margin-top: 5px;
    }
    #editForm button {
      width: 48%;
      margin-top: 10px;
    }
    #editForm .btn-cancel {
      background-color: #dc3545;
    }
    #editForm .btn-cancel:hover {
      background-color: #a71d2a;
    }

    /* PDF için özel stiller */
    .pdf-content {
      background: white;
      padding: 40px;
      margin: 20px;
      border: 1px solid #ddd;
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
    }
    
    .pdf-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 20px;
    }
    
    .pdf-header img {
      max-height: 80px;
      margin-bottom: 15px;
    }
    
    .pdf-title {
      color: #007bff;
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    
    .pdf-body {
      font-size: 16px;
    }
    
    .pdf-body p {
      margin: 12px 0;
    }
    
    .pdf-body strong {
      color: #007bff;
    }
    
    .pdf-footer {
      margin-top: 40px;
      text-align: center;
      font-size: 14px;
      color: #666;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .list-header, .list-item {
        grid-template-columns: 1fr;
        gap: 5px;
      }
      .list-header {
        display: none;
      }
      .list-item {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .search-container {
        flex-direction: column;
      }
      .status-container {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
      }
    }

    /* Yazdır için gizle */
    @media print {
      body * {
        visibility: hidden;
      }
      .pdf-content, .pdf-content * {
        visibility: visible;
      }
      .pdf-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Firebase ve Calendar bağlantı durumu -->
  <div class="status-container">
    <div id="firebaseStatus" class="status-item status-disconnected">
      🔴 Firebase Bağlanıyor...
    </div>
    <div id="calendarStatus" class="status-item status-disconnected">
      🔴 Calendar Bağlantısız
    </div>
  </div>

  <div class="container">
    <div class="logo">
      <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
    </div>
    
    <!-- Google Calendar Yetkilendirme -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button id="authorizeBtn" class="calendar-auth" onclick="handleAuthClick()">
        📅 Google Calendar'a Bağlan
      </button>
      <button id="signoutBtn" class="calendar-auth" onclick="handleSignoutClick()" style="display:none; background-color: #dc3545;">
        🚪 Calendar Bağlantısını Kes
      </button>
    </div>
    
    <h2>TEKLİF OLUŞTUR</h2>

    <label>Müşteri Adı</label>
    <input type="text" id="ad" />

    <label>Çekim Türü</label>
    <input type="text" id="cekim" placeholder="Örn: Düğün, Save the Date, Ürün" />

    <label>Paket Seçimi</label>
    <select id="paket" onchange="paketBilgisiYukle()">
      <option value="">-- Paket Seçin --</option>
      <option value="Standart Ekip">Standart Ekip</option>
      <option value="Profesyonel Ekip">Profesyonel Ekip</option>
    </select>

    <label>Etkinlik Yeri</label>
    <input type="text" id="yer" placeholder="Örn: İstanbul, Kemerburgaz Ormanı" />

    <label>Tarih</label>
    <input type="date" id="tarih" />

    <label>Fiyat (TL)</label>
    <input type="number" id="fiyat" />

    <label>Açıklama</label>
    <textarea id="aciklama" rows="3" placeholder="Detaylar..."></textarea>

    <label>Referans Kişi</label>
    <input type="text" id="referans" placeholder="Seni öneren kişi (isteğe bağlı)" />

    <button onclick="teklifHazirla()" id="teklifBtn">TEKLİFİ OLUŞTUR</button>

    <div id="output"></div>

    <button class="accordion">Teklifler</button>
    <div class="panel" id="tekliflerPanel">
      <div class="search-container">
        <input type="text" id="teklifArama" class="search-input" placeholder="Müşteri adı, paket, yer ile arayın...">
        <button onclick="teklifAra()" class="search-btn">🔍 Ara</button>
        <button onclick="aramaTemizle('teklif')" class="clear-btn">Temizle</button>
      </div>
      <div id="tekliflerListesi" class="list-container"></div>
    </div>

    <button class="accordion">Sözleşmeler</button>
    <div class="panel" id="sozlesmelerPanel">
      <div class="search-container">
        <input type="text" id="sozlesmeArama" class="search-input" placeholder="Müşteri adı, paket, yer ile arayın...">
        <button onclick="sozlesmeAra()" class="search-btn">🔍 Ara</button>
        <button onclick="aramaTemizle('sozlesme')" class="clear-btn">Temizle</button>
      </div>
      <div id="sozlesmelerListesi" class="list-container"></div>
    </div>

    <!-- Düzenleme Formu (gizli) -->
    <div id="editForm" style="display:none;">
      <h3>Teklifi Düzenle</h3>
      <label>Müşteri Adı</label>
      <input type="text" id="editAd" />

      <label>Çekim Türü</label>
      <input type="text" id="editCekim" placeholder="Örn: Düğün, Save the Date, Ürün" />

      <label>Paket Seçimi</label>
      <select id="editPaket" onchange="editPaketBilgisiYukle()">
        <option value="">-- Paket Seçin --</option>
        <option value="Standart Ekip">Standart Ekip</option>
        <option value="Profesyonel Ekip">Profesyonel Ekip</option>
      </select>

      <label>Etkinlik Yeri</label>
      <input type="text" id="editYer" placeholder="Örn: İstanbul, Kemerburgaz Ormanı" />

      <label>Tarih</label>
      <input type="date" id="editTarih" />

      <label>Fiyat (TL)</label>
      <input type="number" id="editFiyat" />

      <label>Açıklama</label>
      <textarea id="editAciklama" rows="3" placeholder="Detaylar..."></textarea>

      <label>Referans Kişi</label>
      <input type="text" id="editReferans" placeholder="Seni öneren kişi (isteğe bağlı)" />

      <button onclick="kaydetDuzenleme()">Kaydet</button>
      <button class="btn-cancel" onclick="iptalDuzenleme()">İptal</button>
    </div>
  </div>

  <!-- PDF içeriği için gizli div -->
  <div id="pdfContent" class="pdf-content" style="display:none;">
    <!-- PDF içeriği buraya dinamik olarak eklenecek -->
  </div>

  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
  
  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDMMpU1l8zabgaw7bfSHKCOxLbz-RhNT7I",
    authDomain: "databasepsv-dc1b7.firebaseapp.com",
    databaseURL: "https://databasepsv-dc1b7-default-rtdb.firebaseio.com",
    projectId: "databasepsv-dc1b7",
    storageBucket: "databasepsv-dc1b7.firebasestorage.app",
    messagingSenderId: "106474799557",
    appId: "1:106474799557:web:8f7cff2b7ef8466ab08bac",
    measurementId: "G-BKKE9YZS1T"
  };

  // Google Calendar API Configuration
  const GOOGLE_CLIENT_ID = '270944409412-g5p51bra8t2cedq1h3mrdobd4dtm871o.apps.googleusercontent.com'; // Bu değeri Google Cloud Console'dan almanız gerekiyor
  const GOOGLE_API_KEY = 'AIzaSyCh7KY4994qjiSXHkfgFTudCCgb67_gMd4'; // Bu değeri Google Cloud Console'dan almanız gerekiyor
  const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
  const SCOPES = 'https://www.googleapis.com/auth/calendar';

  // Firebase'i başlat
  let db;
  let firebaseConnected = false;
  let tokenClient;
  let gapiInited = false;
  let gisInited = false;
  let isCalendarAuthorized = false;

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseConnected = true;
    updateFirebaseStatus(true);
    console.log("Firebase başarıyla bağlandı!");
  } catch (error) {
    console.error("Firebase bağlantı hatası:", error);
    updateFirebaseStatus(false);
    alert("Firebase bağlantısı kurulamadı. Veriler geçici olarak tarayıcıda saklanacak.");
  }

  function updateFirebaseStatus(connected) {
    const statusEl = document.getElementById('firebaseStatus');
    if (connected) {
      statusEl.textContent = '🟢 Firebase Bağlı';
      statusEl.className = 'status-item status-connected';
    } else {
      statusEl.textContent = '🔴 Firebase Bağlantısız';
      statusEl.className = 'status-item status-disconnected';
    }
  }

  function updateCalendarStatus(connected) {
    const statusEl = document.getElementById('calendarStatus');
    if (connected) {
      statusEl.textContent = '🟢 Calendar Bağlı';
      statusEl.className = 'status-item status-connected';
    } else {
      statusEl.textContent = '🔴 Calendar Bağlantısız';
      statusEl.className = 'status-item status-disconnected';
    }
  }

  // Google API yükleme
  window.gapiLoaded = function() {
    gapi.load('client', initializeGapiClient);
  }

  window.gisLoaded = function() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      callback: '', // Bu callback'i daha sonra tanımlayacağız
    });
    gisInited = true;
    maybeEnableButtons();
  }

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: GOOGLE_API_KEY,
      discoveryDocs: [DISCOVERY_DOC]
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('authorizeBtn').style.display = 'block';
    }
  }

  function handleAuthClick() {
    tokenClient.callback = async (resp) => {
      if (resp.error !== undefined) {
        throw (resp);
      }
      isCalendarAuthorized = true;
      updateCalendarStatus(true);
      document.getElementById('authorizeBtn').style.display = 'none';
      document.getElementById('signoutBtn').style.display = 'block';
    };

    if (gapi.client.getToken() === null) {
      tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
      tokenClient.requestAccessToken({prompt: ''});
    }
  }

  function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
      google.accounts.oauth2.revoke(token.access_token);
      gapi.client.setToken('');
      isCalendarAuthorized = false;
      updateCalendarStatus(false);
      document.getElementById('authorizeBtn').style.display = 'block';
      document.getElementById('signoutBtn').style.display = 'none';
    }
  }

  // Google Calendar'a etkinlik ekleme fonksiyonu
  async function addToGoogleCalendar(teklif) {
    if (!isCalendarAuthorized) {
      console.log("Google Calendar yetkilendirmesi yapılmamış");
      return;
    }

    try {
      const etkinlikTarihi = new Date(teklif.tarih);
      const baslangicTarihi = new Date(etkinlikTarihi);
      baslangicTarihi.setHours(10, 0, 0, 0); // Sabah 10:00
      
      const bitisTarihi = new Date(etkinlikTarihi);
      bitisTarihi.setHours(18, 0, 0, 0); // Akşam 18:00

      const event = {
        'summary': `📸 ${teklif.ad} - ${teklif.cekim.replace(/<br>/g, ', ').replace(/- /g, '')}`,
        'location': teklif.yer,
        'description': `
🎯 Çekim Türü: ${teklif.cekim.replace(/<br>/g, '\n')}
📦 Paket: ${teklif.paket}
📍 Yer: ${teklif.yer}
💰 Fiyat: ${teklif.fiyat} TL
📝 Açıklama: ${teklif.aciklama.replace(/<br>/g, '\n')}
${teklif.referans ? `👤 Referans: ${teklif.referans}` : ''}
📅 Teklif Tarihi: ${teklif.bugun}
        `.trim(),
        'start': {
          'dateTime': baslangicTarihi.toISOString(),
          'timeZone': 'Europe/Istanbul'
        },
        'end': {
          'dateTime': bitisTarihi.toISOString(),
          'timeZone': 'Europe/Istanbul'
        },
        'colorId': '4', // Mavi renk
        'reminders': {
          'useDefault': false,
          'overrides': [
            {'method': 'email', 'minutes': 24 * 60}, // 1 gün önce
            {'method': 'popup', 'minutes': 60} // 1 saat önce
          ]
        }
      };

      const request = gapi.client.calendar.events.insert({
        'calendarId': 'primary',
        'resource': event
      });

      const response = await request;
      console.log('Google Calendar etkinliği oluşturuldu:', response.result);
      return response.result;
    } catch (error) {
      console.error('Google Calendar etkinliği oluşturulamadı:', error);
      throw error;
    }
  }

  const paketler = {
    "Standart Ekip": {
      fiyat: 3000,
      aciklama: "2 saat çekim, 30 düzenlenmiş fotoğraf, 1 dakikalık reels"
    },
    "Profesyonel Ekip": {
      fiyat: 5000,
      aciklama: "4 saat çekim, 60 düzenlenmiş fotoğraf, 2 dakikalık klip"
    }
  };

  let teklifler = [];
  let sozlesmeler = [];
  let duzenlenenTeklifId = null;
  let filtreliTeklifler = [];
  let filtreliSozlesmeler = [];

  // Sayfa yüklendiğinde verileri çek
  window.addEventListener('load', async () => {
    await veriCek();
    
    // Google APIs yükle
    const script1 = document.createElement('script');
    script1.src = 'https://apis.google.com/js/api.js';
    script1.onload = window.gapiLoaded;
    document.head.appendChild(script1);

    const script2 = document.createElement('script');
    script2.src = 'https://accounts.google.com/gsi/client';
    script2.onload = window.gisLoaded;
    document.head.appendChild(script2);
  });

  // Firebase'den verileri çek
  async function veriCek() {
    if (!firebaseConnected) {
      console.log("Firebase bağlantısı yok, yerel veriler kullanılıyor.");
      return;
    }

    try {
      showLoading("tekliflerListesi");
      showLoading("sozlesmelerListesi");

      // Teklifleri çek
      const teklifSnapshot = await db.collection('teklifler').orderBy('createdAt', 'desc').get();
      teklifler = [];
      teklifSnapshot.forEach(doc => {
        teklifler.push({
          id: doc.id,
          ...doc.data()
        });
      });

      // Sözleşmeleri çek
      const sozlesmeSnapshot = await db.collection('sozlesmeler').orderBy('createdAt', 'desc').get();
      sozlesmeler = [];
      sozlesmeSnapshot.forEach(doc => {
        sozlesmeler.push({
          id: doc.id,
          ...doc.data()
        });
      });

      filtreliTeklifler = [...teklifler];
      filtreliSozlesmeler = [...sozlesmeler];
      renderTeklifler();
      renderSozlesmeler();
    } catch (error) {
      console.error("Veri çekme hatası:", error);
      document.getElementById('output').innerHTML = `
        <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px;">
          ❌ Veriler yüklenirken hata oluştu: ${error.message}
        </div>
      `;
    }
  }

  function showLoading(containerId) {
    document.getElementById(containerId).innerHTML = `
      <div class="loading-text">
        <div class="loading"></div>
        Veriler yükleniyor...
      </div>
    `;
  }

  // Accordion aç/kapa
  document.querySelectorAll(".accordion").forEach(button => {
    button.addEventListener("click", () => {
      button.classList.toggle("active");
      const panel = button.nextElementSibling;
      if(panel.style.display === "block") {
        panel.style.display = "none";
      } else {
        panel.style.display = "block";
      }
    });
  });

  function paketBilgisiYukle() {
    const secilen = document.getElementById("paket").value;
    if (paketler[secilen]) {
      document.getElementById("fiyat").value = paketler[secilen].fiyat;
      document.getElementById("aciklama").value = paketler[secilen].aciklama;
    }
  }

  function editPaketBilgisiYukle() {
    const secilen = document.getElementById("editPaket").value;
    if (paketler[secilen]) {
      document.getElementById("editFiyat").value = paketler[secilen].fiyat;
      document.getElementById("editAciklama").value = paketler[secilen].aciklama;
    }
  }

  async function teklifHazirla() {
    const ad = document.getElementById("ad").value.trim();
    if (!ad) {
      alert("Müşteri adı boş bırakılamaz!");
      return;
    }

    const tarih = document.getElementById("tarih").value;
    if (!tarih) {
      alert("Etkinlik tarihi boş bırakılamaz!");
      return;
    }

    const btn = document.getElementById("teklifBtn");
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Teklif Oluşturuluyor...';

   const cekim = document.getElementById("cekim").value
      .split(',')
      .map(c => c.trim())
      .filter(Boolean)
      .map(c => `- ${c}`)
      .join('<br>');

    const teklif = {
      ad: ad,
      cekim: cekim,
      paket: document.getElementById("paket").value,
      yer: document.getElementById("yer").value,
      tarih: tarih,
      fiyat: document.getElementById("fiyat").value,
      aciklama: document.getElementById("aciklama").value,
      referans: document.getElementById("referans").value,
      bugun: new Date().toLocaleDateString('tr-TR'),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      let teklifId;
      
      // Firebase'e kaydet
      if (firebaseConnected) {
        const docRef = await db.collection('teklifler').add(teklif);
        teklifId = docRef.id;
        console.log("Teklif Firebase'e kaydedildi:", teklifId);
      } else {
        // Yerel kayıt
        teklifId = 'local_' + Date.now();
        teklif.id = teklifId;
        teklifler.push(teklif);
      }

      // Google Calendar'a ekle
      if (isCalendarAuthorized) {
        try {
          await addToGoogleCalendar(teklif);
          console.log("Teklif Google Calendar'a eklendi");
        } catch (calendarError) {
          console.error("Google Calendar ekleme hatası:", calendarError);
          // Calendar hatası olsa bile teklif oluşturulmuş olsun
        }
      }

      // Başarı mesajı
      const teklifHTML = `
        <div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 20px 0;">
          <h3 style="color: #2e7d32; margin-top: 0;">✅ Teklif Başarıyla Oluşturuldu!</h3>
          <p><strong>Müşteri:</strong> ${ad}</p>
          <p><strong>Çekim Türü:</strong><br>${cekim}</p>
          <p><strong>Paket:</strong> ${teklif.paket}</p>
          <p><strong>Yer:</strong> ${teklif.yer}</p>
          <p><strong>Tarih:</strong> ${new Date(tarih).toLocaleDateString('tr-TR')}</p>
          <p><strong>Fiyat:</strong> ${teklif.fiyat} TL</p>
          <p><strong>Açıklama:</strong> ${teklif.aciklama}</p>
          ${teklif.referans ? `<p><strong>Referans:</strong> ${teklif.referans}</p>` : ''}
          <p><strong>Teklif Tarihi:</strong> ${teklif.bugun}</p>
          ${isCalendarAuthorized ? '<p style="color: #4285f4;">📅 Google Calendar\'a da eklendi!</p>' : '<p style="color: #ff9800;">⚠️ Google Calendar\'a eklenemedi (yetkilendirme gerekli)</p>'}
        </div>
      `;

      document.getElementById("output").innerHTML = teklifHTML;

      // Formu temizle
      document.getElementById("ad").value = '';
      document.getElementById("cekim").value = '';
      document.getElementById("paket").value = '';
      document.getElementById("yer").value = '';
      document.getElementById("tarih").value = '';
      document.getElementById("fiyat").value = '';
      document.getElementById("aciklama").value = '';
      document.getElementById("referans").value = '';

      // Listeleri güncelle
      await veriCek();

    } catch (error) {
      console.error("Teklif oluşturma hatası:", error);
      document.getElementById("output").innerHTML = `
        <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px;">
          ❌ Teklif oluşturulurken hata oluştu: ${error.message}
        </div>
      `;
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'TEKLİFİ OLUŞTUR';
    }
  }

  function renderTeklifler() {
    const container = document.getElementById('tekliflerListesi');
    
    if (filtreliTeklifler.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          📋 Henüz teklif bulunmuyor
        </div>
      `;
      return;
    }

    let html = `
      <div class="list-header">
        <div>Müşteri</div>
        <div>Paket</div>
        <div>Tarih</div>
        <div>Fiyat</div>
        <div>Durum</div>
        <div>İşlemler</div>
      </div>
    `;

    filtreliTeklifler.forEach(teklif => {
      const tarihFormatli = teklif.tarih ? new Date(teklif.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemiş';
      const fiyatFormatli = teklif.fiyat ? `${teklif.fiyat} TL` : 'Belirtilmemiş';
      
      html += `
        <div class="list-item">
          <div><strong>${teklif.ad}</strong><br><small>${teklif.yer || 'Yer belirtilmemiş'}</small></div>
          <div>${teklif.paket || 'Belirtilmemiş'}</div>
          <div>${tarihFormatli}</div>
          <div>${fiyatFormatli}</div>
          <div><span style="color: #ff9800;">⏳ Bekliyor</span></div>
          <div class="list-actions">
            <button class="btn-view" onclick="teklifGoster('${teklif.id}')">👁️</button>
            <button class="btn-edit" onclick="teklifDuzenle('${teklif.id}')">✏️</button>
            <button class="btn-delete" onclick="teklifSil('${teklif.id}')">🗑️</button>
            <button class="btn-contract" onclick="sozlesmeOlustur('${teklif.id}')">📄</button>
            <button class="btn-pdf" onclick="pdfOlustur('${teklif.id}')">📄</button>
            <button class="btn-calendar" onclick="teklifTakvimeEkle('${teklif.id}')" ${!isCalendarAuthorized ? 'disabled' : ''}>📅</button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function renderSozlesmeler() {
    const container = document.getElementById('sozlesmelerListesi');
    
    if (filtreliSozlesmeler.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          📋 Henüz sözleşme bulunmuyor
        </div>
      `;
      return;
    }

    let html = `
      <div class="list-header">
        <div>Müşteri</div>
        <div>Paket</div>
        <div>Tarih</div>
        <div>Fiyat</div>
        <div>Durum</div>
        <div>İşlemler</div>
      </div>
    `;

    filtreliSozlesmeler.forEach(sozlesme => {
      const tarihFormatli = sozlesme.tarih ? new Date(sozlesme.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemiş';
      const fiyatFormatli = sozlesme.fiyat ? `${sozlesme.fiyat} TL` : 'Belirtilmemiş';
      
      html += `
        <div class="list-item">
          <div><strong>${sozlesme.ad}</strong><br><small>${sozlesme.yer || 'Yer belirtilmemiş'}</small></div>
          <div>${sozlesme.paket || 'Belirtilmemiş'}</div>
          <div>${tarihFormatli}</div>
          <div>${fiyatFormatli}</div>
          <div><span style="color: #4caf50;">✅ Aktif</span></div>
          <div class="list-actions">
            <button class="btn-view" onclick="sozlesmeGoster('${sozlesme.id}')">👁️</button>
            <button class="btn-edit" onclick="sozlesmeDuzenle('${sozlesme.id}')">✏️</button>
            <button class="btn-delete" onclick="sozlesmeSil('${sozlesme.id}')">🗑️</button>
            <button class="btn-pdf" onclick="sozlesmePdfOlustur('${sozlesme.id}')">📄</button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // Teklifi manuel olarak takvime ekleme
  async function teklifTakvimeEkle(teklifId) {
    if (!isCalendarAuthorized) {
      alert('Google Calendar yetkilendirmesi gerekiyor!');
      return;
    }

    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) {
      alert('Teklif bulunamadı!');
      return;
    }

    try {
      await addToGoogleCalendar(teklif);
      alert('Teklif Google Calendar\'a eklendi!');
    } catch (error) {
      console.error('Calendar ekleme hatası:', error);
      alert('Google Calendar\'a eklenirken hata oluştu: ' + error.message);
    }
  }

  // Teklif göster
  function teklifGoster(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) return;

    const tarihFormatli = teklif.tarih ? new Date(teklif.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemiş';
    
    const html = `
      <div style="background: #f8f9fa; border: 2px solid #007bff; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <h3 style="color: #007bff; margin-top: 0;">📋 Teklif Detayları</h3>
        <p><strong>Müşteri:</strong> ${teklif.ad}</p>
        <p><strong>Çekim Türü:</strong><br>${teklif.cekim}</p>
        <p><strong>Paket:</strong> ${teklif.paket}</p>
        <p><strong>Yer:</strong> ${teklif.yer}</p>
        <p><strong>Tarih:</strong> ${tarihFormatli}</p>
        <p><strong>Fiyat:</strong> ${teklif.fiyat} TL</p>
        <p><strong>Açıklama:</strong> ${teklif.aciklama}</p>
        ${teklif.referans ? `<p><strong>Referans:</strong> ${teklif.referans}</p>` : ''}
        <p><strong>Teklif Tarihi:</strong> ${teklif.bugun}</p>
      </div>
    `;
    
    document.getElementById('output').innerHTML = html;
  }

  // Teklif düzenle
  function teklifDuzenle(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) return;

    duzenlenenTeklifId = teklifId;
    
    document.getElementById('editAd').value = teklif.ad;
    document.getElementById('editCekim').value = teklif.cekim.replace(/<br>/g, ', ').replace(/- /g, '');
    document.getElementById('editPaket').value = teklif.paket;
    document.getElementById('editYer').value = teklif.yer;
    document.getElementById('editTarih').value = teklif.tarih;
    document.getElementById('editFiyat').value = teklif.fiyat;
    document.getElementById('editAciklama').value = teklif.aciklama;
    document.getElementById('editReferans').value = teklif.referans || '';
    
    document.getElementById('editForm').style.display = 'block';
    document.getElementById('editForm').scrollIntoView({ behavior: 'smooth' });
  }

  // Düzenleme kaydet
  async function kaydetDuzenleme() {
    if (!duzenlenenTeklifId) return;

    const ad = document.getElementById('editAd').value.trim();
    if (!ad) {
      alert('Müşteri adı boş bırakılamaz!');
      return;
    }

    const cekim = document.getElementById('editCekim').value
      .split(',')
      .map(c => c.trim())
      .filter(Boolean)
      .map(c => `- ${c}`)
      .join('<br>');

    const guncellenenTeklif = {
      ad: ad,
      cekim: cekim,
      paket: document.getElementById('editPaket').value,
      yer: document.getElementById('editYer').value,
      tarih: document.getElementById('editTarih').value,
      fiyat: document.getElementById('editFiyat').value,
      aciklama: document.getElementById('editAciklama').value,
      referans: document.getElementById('editReferans').value,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      if (firebaseConnected) {
        await db.collection('teklifler').doc(duzenlenenTeklifId).update(guncellenenTeklif);
      } else {
        const index = teklifler.findIndex(t => t.id === duzenlenenTeklifId);
        if (index !== -1) {
          teklifler[index] = { ...teklifler[index], ...guncellenenTeklif };
        }
      }

      document.getElementById('editForm').style.display = 'none';
      duzenlenenTeklifId = null;
      
      alert('Teklif başarıyla güncellendi!');
      await veriCek();
    } catch (error) {
      console.error('Güncelleme hatası:', error);
      alert('Güncelleme hatası: ' + error.message);
    }
  }

  // Düzenleme iptal
  function iptalDuzenleme() {
    document.getElementById('editForm').style.display = 'none';
    duzenlenenTeklifId = null;
  }

  // Teklif sil
  async function teklifSil(teklifId) {
    if (!confirm('Bu teklifi silmek istediğinizden emin misiniz?')) return;

    try {
      if (firebaseConnected) {
        await db.collection('teklifler').doc(teklifId).delete();
      } else {
        teklifler = teklifler.filter(t => t.id !== teklifId);
      }
      
      alert('Teklif silindi!');
      await veriCek();
    } catch (error) {
      console.error('Silme hatası:', error);
      alert('Silme hatası: ' + error.message);
    }
  }

  // Sözleşme oluştur
  async function sozlesmeOlustur(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) return;

    if (!confirm('Bu tekliften sözleşme oluşturmak istediğinizden emin misiniz?')) return;

    const sozlesme = {
      ...teklif,
      teklifId: teklifId,
      sozlesmeTarihi: new Date().toLocaleDateString('tr-TR'),
      durum: 'aktif',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    delete sozlesme.id;

    try {
      if (firebaseConnected) {
        await db.collection('sozlesmeler').add(sozlesme);
      } else {
        sozlesme.id = 'sozlesme_' + Date.now();
        sozlesmeler.push(sozlesme);
      }
      
      alert('Sözleşme oluşturuldu!');
      await veriCek();
    } catch (error) {
      console.error('Sözleşme oluşturma hatası:', error);
      alert('Sözleşme oluşturma hatası: ' + error.message);
    }
  }

  // PDF oluştur
  function pdfOlustur(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) return;

    const tarihFormatli = teklif.tarih ? new Date(teklif.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemiş';
    
    const pdfContent = `
      <div class="pdf-header">
        <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
        <h1 class="pdf-title">TEKLİF FORMU</h1>
      </div>
      <div class="pdf-body">
        <p><strong>Müşteri Adı:</strong> ${teklif.ad}</p>
        <p><strong>Çekim Türü:</strong><br>${teklif.cekim}</p>
        <p><strong>Paket Seçimi:</strong> ${teklif.paket}</p>
        <p><strong>Etkinlik Yeri:</strong> ${teklif.yer}</p>
        <p><strong>Etkinlik Tarihi:</strong> ${tarihFormatli}</p>
        <p><strong>Fiyat:</strong> ${teklif.fiyat} TL</p>
        <p><strong>Açıklama:</strong> ${teklif.aciklama}</p>
        ${teklif.referans ? `<p><strong>Referans Kişi:</strong> ${teklif.referans}</p>` : ''}
        <p><strong>Teklif Tarihi:</strong> ${teklif.bugun}</p>
      </div>
      <div class="pdf-footer">
        <p>Bu teklif 30 gün geçerlidir.</p>
        <p>Teşekkür ederiz.</p>
      </div>
    `;
    
    document.getElementById('pdfContent').innerHTML = pdfContent;
    document.getElementById('pdfContent').style.display = 'block';
    
    setTimeout(() => {
      window.print();
      document.getElementById('pdfContent').style.display = 'none';
    }, 100);
  }

  // Sözleşme göster
  function sozlesmeGoster(sozlesmeId) {
    const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
    if (!sozlesme) return;

    const tarihFormatli = sozlesme.tarih ? new Date(sozlesme.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemiş';
    
    const html = `
      <div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <h3 style="color: #4caf50; margin-top: 0;">📄 Sözleşme Detayları</h3>
        <p><strong>Müşteri:</strong> ${sozlesme.ad}</p>
        <p><strong>Çekim Türü:</strong><br>${sozlesme.cekim}</p>
        <p><strong>Paket:</strong> ${sozlesme.paket}</p>
        <p><strong>Yer:</strong> ${sozlesme.yer}</p>
        <p><strong>Tarih:</strong> ${tarihFormatli}</p>
        <p><strong>Fiyat:</strong> ${sozlesme.fiyat} TL</p>
        <p><strong>Açıklama:</strong> ${sozlesme.aciklama}</p>
        ${sozlesme.referans ? `<p><strong>Referans:</strong> ${sozlesme.referans}</p>` : ''}
        <p><strong>Sözleşme Tarihi:</strong> ${sozlesme.sozlesmeTarihi}</p>
        <p><strong>Durum:</strong> <span style="color: #4caf50;">✅ Aktif</span></p>
      </div>
    `;
    
    document.getElementById('output').innerHTML = html;
  }

  // Sözleşme düzenle
  function sozlesmeDuzenle(sozlesmeId) {
    alert('Sözleşme düzenleme özelliği yakında eklenecek.');
  }

  // Sözleşme sil
  async function sozlesmeSil(sozlesmeId) {
    if (!confirm('Bu sözleşmeyi silmek istediğinizden emin misiniz?')) return;

    try {
      if (firebaseConnected) {
        await db.collection('sozlesmeler').doc(sozlesmeId).delete();
      } else {
        sozlesmeler = sozlesmeler.filter(s => s.id !== sozlesmeId);
      }
      
      alert('Sözleşme silindi!');
      await veriCek();
    } catch (error) {
      console.error('Silme hatası:', error);
      alert('Silme hatası: ' + error.message);
    }
  }

  // Sözleşme PDF oluştur
  function sozlesmePdfOlustur(sozlesmeId) {
    const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
    if (!sozlesme) return;

    const tarihFormatli = sozlesme.tarih ? new Date(sozlesme.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemiş';
    
    const pdfContent = `
      <div class="pdf-header">
        <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
        <h1 class="pdf-title">SÖZLEŞME</h1>
      </div>
      <div class="pdf-body">
        <p><strong>Müşteri Adı:</strong> ${sozlesme.ad}</p>
        <p><strong>Çekim Türü:</strong><br>${sozlesme.cekim}</p>
        <p><strong>Paket Seçimi:</strong> ${sozlesme.paket}</p>
        <p><strong>Etkinlik Yeri:</strong> ${sozlesme.yer}</p>
        <p><strong>Etkinlik Tarihi:</strong> ${tarihFormatli}</p>
        <p><strong>Fiyat:</strong> ${sozlesme.fiyat} TL</p>
        <p><strong>Açıklama:</strong> ${sozlesme.aciklama}</p>
        ${sozlesme.referans ? `<p><strong>Referans Kişi:</strong> ${sozlesme.referans}</p>` : ''}
        <p><strong>Sözleşme Tarihi:</strong> ${sozlesme.sozlesmeTarihi}</p>
        <p><strong>Durum:</strong> Aktif</p>
      </div>
      <div class="pdf-footer">
        <p>Bu sözleşme yasal olarak bağlayıcıdır.</p>
        <p>İyi çalışmalar dileriz.</p>
      </div>
    `;
    
    document.getElementById('pdfContent').innerHTML = pdfContent;
    document.getElementById('pdfContent').style.display = 'block';
    
    setTimeout(() => {
      window.print();
      document.getElementById('pdfContent').style.display = 'none';
    }, 100);
  }

  // Arama fonksiyonları
  function teklifAra() {
    const arama = document.getElementById('teklifArama').value.toLowerCase().trim();
    if (!arama) {
      filtreliTeklifler = [...teklifler];
    } else {
      filtreliTeklifler = teklifler.filter(teklif => 
        teklif.ad.toLowerCase().includes(arama) ||
        (teklif.paket && teklif.paket.toLowerCase().includes(arama)) ||
        (teklif.yer && teklif.yer.toLowerCase().includes(arama)) ||
        (teklif.cekim && teklif.cekim.toLowerCase().includes(arama))
      );
    }
    renderTeklifler();
  }

  function sozlesmeAra() {
    const arama = document.getElementById('sozlesmeArama').value.toLowerCase().trim();
    if (!arama) {
      filtreliSozlesmeler = [...sozlesmeler];
    } else {
      filtreliSozlesmeler = sozlesmeler.filter(sozlesme => 
        sozlesme.ad.toLowerCase().includes(arama) ||
        (sozlesme.paket && sozlesme.paket.toLowerCase().includes(arama)) ||
        (sozlesme.yer && sozlesme.yer.toLowerCase().includes(arama)) ||
        (sozlesme.cekim && sozlesme.cekim.toLowerCase().includes(arama))
      );
    }
    renderSozlesmeler();
  }

  function aramaTemizle(tip) {
    if (tip === 'teklif') {
      document.getElementById('teklifArama').value = '';
      filtreliTeklifler = [...teklifler];
      renderTeklifler();
    } else if (tip === 'sozlesme') {
      document.getElementById('sozlesmeArama').value = '';
      filtreliSozlesmeler = [...sozlesmeler];
      renderSozlesmeler();
    }
  }

  // Enter tuşu ile arama
  document.getElementById('teklifArama').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      teklifAra();
    }
  });

  document.getElementById('sozlesmeArama').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sozlesmeAra();
    }
  });

  // Otomatik arama (her tuş vuruşunda)
  document.getElementById('teklifArama').addEventListener('input', teklifAra);
  document.getElementById('sozlesmeArama').addEventListener('input', sozlesmeAra);

</script>

</body>
</html>
