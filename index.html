<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Teklif ve S√∂zle≈üme Y√∂netimi</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .logo {text-align:center; margin-bottom:20px;}
    .logo img {width: 150px;}
    h2 {text-align:center; color:#333; margin-bottom:30px;}

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Firebase ve Google Calendar baƒülantƒ± durumu */
    .status-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    .status-item {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .status-connected {
      background-color: #28a745;
      color: white;
    }
    .status-disconnected {
      background-color: #dc3545;
      color: white;
    }

    /* Calendar Auth Button */
    .calendar-auth {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .calendar-auth:hover {
      background-color: #3367d6;
    }

    /* Liste Tasarƒ±mƒ± */
    .search-container {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #007bff;
      border-radius: 5px;
      font-size: 14px;
    }
    .search-btn {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: auto;
    }
    .clear-btn {
      padding: 10px 15px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: auto;
    }

    .list-container {
      background: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }
    .list-header {
      background: #007bff;
      color: white;
      padding: 15px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 170px;
      gap: 10px;
      font-weight: bold;
      font-size: 14px;
    }
    .list-header.sozlesme {
      background: #dc3545;
    }
    .list-item {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 170px;
      gap: 10px;
      align-items: center;
      background: white;
      transition: background-color 0.2s;
      font-size: 14px;
    }
    .list-item:hover {
      background-color: #f8f9fa;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .list-actions button {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 3px;
      width: auto;
      margin: 0;
      border: none;
      cursor: pointer;
      color: white;
    }
    .btn-view { background: #17a2b8; }
    .btn-edit { background: #ffc107; color: #212529; }
    .btn-delete { background: #dc3545; }
    .btn-contract { background: #28a745; }
    .btn-pdf { background: #6c757d; }
    .btn-calendar { background: #4285f4; }
    .btn-calendar:disabled { background: #ccc; cursor: not-allowed; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }

    /* Accordion Men√º */
    .accordion {
      color: white;
      cursor: pointer;
      padding: 15px 20px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      border-radius: 8px;
      margin-top: 25px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .accordion.teklif {
      background-color: #007bff;
    }
    .accordion.teklif:hover {
      background-color: #0056b3;
    }
    .accordion.teklif.active {
      background-color: #00408d;
    }
    .accordion.sozlesme {
      background-color: #dc3545;
    }
    .accordion.sozlesme:hover {
      background-color: #c82333;
    }
    .accordion.sozlesme.active {
      background-color: #bd2130;
    }
    .panel {
      padding: 0;
      display: none;
      background-color: white;
      overflow: hidden;
      border-radius: 0 0 8px 8px;
    }
    .panel.teklif {
      border: 1px solid #007bff;
      border-top: none;
    }
    .panel.sozlesme {
      border: 1px solid #dc3545;
      border-top: none;
    }

    #output {
      margin-top: 30px;
      min-height: 180px;
    }

    /* PDF i√ßin √∂zel stiller */
    .pdf-content {
      background: white;
      padding: 40px;
      margin: 20px;
      border: 1px solid #ddd;
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
    }
    
    .pdf-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 20px;
    }
    
    .pdf-header img {
      max-height: 80px;
      margin-bottom: 15px;
    }
    
    .pdf-title {
      color: #007bff;
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    
    .pdf-body {
      font-size: 16px;
    }
    
    .pdf-body p {
      margin: 12px 0;
    }
    
    .pdf-body strong {
      color: #007bff;
    }
    
    .pdf-footer {
      margin-top: 40px;
      text-align: center;
      font-size: 14px;
      color: #666;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .list-header, .list-item {
        grid-template-columns: 1fr;
        gap: 5px;
      }
      .list-header {
        display: none;
      }
      .list-item {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .search-container {
        flex-direction: column;
      }
      .status-container {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
      }
    }

    /* Yazdƒ±r i√ßin gizle */
    @media print {
      body * {
        visibility: hidden;
      }
      .pdf-content, .pdf-content * {
        visibility: visible;
      }
      .pdf-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Firebase ve Calendar baƒülantƒ± durumu -->
  <div class="status-container">
    <div id="firebaseStatus" class="status-item status-disconnected">
      üî¥ Firebase Baƒülanƒ±yor...
    </div>
    <div id="calendarStatus" class="status-item status-disconnected">
      üî¥ Calendar Baƒülantƒ±sƒ±z
    </div>
  </div>

  <div class="container">
    <div class="logo">
      <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
    </div>
    
    <!-- Google Calendar Yetkilendirme -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button id="authorizeBtn" class="calendar-auth" onclick="handleAuthClick()">
        üìÖ Google Calendar'a Baƒülan
      </button>
      <button id="signoutBtn" class="calendar-auth" onclick="handleSignoutClick()" style="display:none; background-color: #dc3545;">
        üö™ Calendar Baƒülantƒ±sƒ±nƒ± Kes
      </button>
    </div>
    
    <h2>TEKLƒ∞F VE S√ñZLE≈ûME Y√ñNETƒ∞Mƒ∞</h2>

    <div id="output"></div>

    <button class="accordion teklif">üìã Teklifler</button>
    <div class="panel teklif" id="tekliflerPanel">
      <div class="search-container">
        <input type="text" id="teklifArama" class="search-input" placeholder="M√º≈üteri adƒ±, paket, yer ile arayƒ±n...">
        <button onclick="teklifAra()" class="search-btn">üîç Ara</button>
        <button onclick="aramaTemizle('teklif')" class="clear-btn">Temizle</button>
      </div>
      <div id="tekliflerListesi" class="list-container"></div>
    </div>

    <button class="accordion sozlesme">üìÑ S√∂zle≈ümeler</button>
    <div class="panel sozlesme" id="sozlesmelerPanel">
      <div class="search-container">
        <input type="text" id="sozlesmeArama" class="search-input" placeholder="M√º≈üteri adƒ±, paket, yer ile arayƒ±n...">
        <button onclick="sozlesmeAra()" class="search-btn">üîç Ara</button>
        <button onclick="aramaTemizle('sozlesme')" class="clear-btn">Temizle</button>
      </div>
      <div id="sozlesmelerListesi" class="list-container"></div>
    </div>
  </div>

  <!-- PDF i√ßeriƒüi i√ßin gizli div -->
  <div id="pdfContent" class="pdf-content" style="display:none;">
    <!-- PDF i√ßeriƒüi buraya dinamik olarak eklenecek -->
  </div>

  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
  
  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDMMpU1l8zabgaw7bfSHKCOxLbz-RhNT7I",
    authDomain: "databasepsv-dc1b7.firebaseapp.com",
    databaseURL: "https://databasepsv-dc1b7-default-rtdb.firebaseio.com",
    projectId: "databasepsv-dc1b7",
    storageBucket: "databasepsv-dc1b7.firebasestorage.app",
    messagingSenderId: "106474799557",
    appId: "1:106474799557:web:8f7cff2b7ef8466ab08bac",
    measurementId: "G-BKKE9YZS1T"
  };

  // Google Calendar API Configuration
  const GOOGLE_CLIENT_ID = '270944409412-g5p51bra8t2cedq1h3mrdobd4dtm871o.apps.googleusercontent.com';
  const GOOGLE_API_KEY = 'AIzaSyCh7KY4994qjiSXHkfgFTudCCgb67_gMd4';
  const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
  const SCOPES = 'https://www.googleapis.com/auth/calendar';

  // Firebase'i ba≈ülat
  let db;
  let firebaseConnected = false;
  let tokenClient;
  let gapiInited = false;
  let gisInited = false;
  let isCalendarAuthorized = false;

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseConnected = true;
    updateFirebaseStatus(true);
    console.log("Firebase ba≈üarƒ±yla baƒülandƒ±!");
  } catch (error) {
    console.error("Firebase baƒülantƒ± hatasƒ±:", error);
    updateFirebaseStatus(false);
    alert("Firebase baƒülantƒ±sƒ± kurulamadƒ±. Veriler ge√ßici olarak tarayƒ±cƒ±da saklanacak.");
  }

  function updateFirebaseStatus(connected) {
    const statusEl = document.getElementById('firebaseStatus');
    if (connected) {
      statusEl.textContent = 'üü¢ Firebase Baƒülƒ±';
      statusEl.className = 'status-item status-connected';
    } else {
      statusEl.textContent = 'üî¥ Firebase Baƒülantƒ±sƒ±z';
      statusEl.className = 'status-item status-disconnected';
    }
  }

  function updateCalendarStatus(connected) {
    const statusEl = document.getElementById('calendarStatus');
    if (connected) {
      statusEl.textContent = 'üü¢ Calendar Baƒülƒ±';
      statusEl.className = 'status-item status-connected';
    } else {
      statusEl.textContent = 'üî¥ Calendar Baƒülantƒ±sƒ±z';
      statusEl.className = 'status-item status-disconnected';
    }
  }

  // Google API y√ºkleme
  window.gapiLoaded = function() {
    gapi.load('client', initializeGapiClient);
  }

  window.gisLoaded = function() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      callback: '',
    });
    gisInited = true;
    maybeEnableButtons();
  }

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: GOOGLE_API_KEY,
      discoveryDocs: [DISCOVERY_DOC]
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('authorizeBtn').style.display = 'block';
    }
  }

  function handleAuthClick() {
    tokenClient.callback = async (resp) => {
      if (resp.error !== undefined) {
        throw (resp);
      }
      isCalendarAuthorized = true;
      updateCalendarStatus(true);
      document.getElementById('authorizeBtn').style.display = 'none';
      document.getElementById('signoutBtn').style.display = 'block';
    };

    if (gapi.client.getToken() === null) {
      tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
      tokenClient.requestAccessToken({prompt: ''});
    }
  }

  function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
      google.accounts.oauth2.revoke(token.access_token);
      gapi.client.setToken('');
      isCalendarAuthorized = false;
      updateCalendarStatus(false);
      document.getElementById('authorizeBtn').style.display = 'block';
      document.getElementById('signoutBtn').style.display = 'none';
    }
  }

  // Google Calendar'a etkinlik ekleme fonksiyonu (T√ºm g√ºn etkinliƒüi)
async function addToGoogleCalendar(item, tip) {
  try {
    if (!gapi.client || !gapi.client.calendar) {
      console.error('Google API y√ºklenmemi≈ü!');
      alert('Google API hen√ºz y√ºklenmedi. L√ºtfen sayfayƒ± yenileyip tekrar deneyin.');
      return;
    }

    if (!isCalendarAuthorized) {
      alert("Google Calendar baƒülantƒ±sƒ± yapƒ±lmadƒ±. √ñnce yetkilendirme yapmalƒ±sƒ±nƒ±z.");
      return;
    }

    let etkinlikTarihi = item.tarih ? new Date(item.tarih) : new Date();
    if (isNaN(etkinlikTarihi)) {
      alert('Tarih formatƒ± hatalƒ±! L√ºtfen ge√ßerli bir tarih girin.');
      return;
    }

    const tarihStr = etkinlikTarihi.toISOString().split('T')[0];

    const event = {
      summary: `${tip === 'teklif' ? 'üìã TEKLƒ∞F' : 'üìÑ S√ñZLE≈ûME'}: ${item.ad}`,
      location: item.yer || '',
      description: `
üë§ M√º≈üteri: ${item.ad}
üìû Telefon: ${item.telefon || 'Belirtilmemi≈ü'}
üì¶ Paket: ${item.paket || 'Belirtilmemi≈ü'}
üìç Yer: ${item.yer || 'Belirtilmemi≈ü'}
üí∞ Fiyat: ${item.fiyat || 'Belirtilmemi≈ü'} TL
üéØ √áekim T√ºr√º: ${(item.cekim || '').replace(/<br>/g, '\n')}
üìù A√ßƒ±klama: ${(item.aciklama || '').replace(/<br>/g, '\n')}
${item.referans ? `üë§ Referans: ${item.referans}` : ''}
`.trim(),
      start: {
        date: tarihStr,
        timeZone: 'Europe/Istanbul'
      },
      end: {
        date: tarihStr,
        timeZone: 'Europe/Istanbul'
      },
      reminders: {
        useDefault: false,
        overrides: [
          { method: 'email', minutes: 24 * 60 },
          { method: 'popup', minutes: 60 }
        ]
      }
    };

    const response = await gapi.client.calendar.events.insert({
      calendarId: 'primary',
      resource: event
    });

    console.log('Takvime ba≈üarƒ±yla eklendi:', response.result);
    alert('Etkinlik Google Calendar\'a ba≈üarƒ±yla eklendi!');
  } catch (error) {
    console.error('Takvim ekleme hatasƒ±:', error);
    alert('Google Calendar\'a eklenirken hata olu≈ütu: ' + error.message);
  }
}



  let teklifler = [];
  let sozlesmeler = [];
  let filtreliTeklifler = [];
  let filtreliSozlesmeler = [];

  // Sayfa y√ºklendiƒüinde verileri √ßek
  window.addEventListener('load', async () => {
    await veriCek();
    
    // Google APIs y√ºkle
    const script1 = document.createElement('script');
    script1.src = 'https://apis.google.com/js/api.js';
    script1.onload = window.gapiLoaded;
    document.head.appendChild(script1);

    const script2 = document.createElement('script');
    script2.src = 'https://accounts.google.com/gsi/client';
    script2.onload = window.gisLoaded;
    document.head.appendChild(script2);
  });

  // Firebase'den verileri √ßek
  async function veriCek() {
    if (!firebaseConnected) {
      console.log("Firebase baƒülantƒ±sƒ± yok, yerel veriler kullanƒ±lƒ±yor.");
      return;
    }

    try {
      showLoading("tekliflerListesi");
      showLoading("sozlesmelerListesi");

      // Teklifleri √ßek
      const teklifSnapshot = await db.collection('teklifler').orderBy('createdAt', 'desc').get();
      teklifler = [];
      teklifSnapshot.forEach(doc => {
        teklifler.push({
          id: doc.id,
          ...doc.data()
        });
      });

      // S√∂zle≈ümeleri √ßek
      const sozlesmeSnapshot = await db.collection('sozlesmeler').orderBy('createdAt', 'desc').get();
      sozlesmeler = [];
      sozlesmeSnapshot.forEach(doc => {
        sozlesmeler.push({
          id: doc.id,
          ...doc.data()
        });
      });

      filtreliTeklifler = [...teklifler];
      filtreliSozlesmeler = [...sozlesmeler];
      renderTeklifler();
      renderSozlesmeler();
    } catch (error) {
      console.error("Veri √ßekme hatasƒ±:", error);
      document.getElementById('output').innerHTML = `
        <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px;">
          ‚ùå Veriler y√ºklenirken hata olu≈ütu: ${error.message}
        </div>
      `;
    }
  }

  function showLoading(containerId) {
    document.getElementById(containerId).innerHTML = `
      <div class="loading-text">
        <div class="loading"></div>
        Veriler y√ºkleniyor...
      </div>
    `;
  }

  // Accordion a√ß/kapa
  document.querySelectorAll(".accordion").forEach(button => {
    button.addEventListener("click", () => {
      button.classList.toggle("active");
      const panel = button.nextElementSibling;
      if(panel.style.display === "block") {
        panel.style.display = "none";
      } else {
        panel.style.display = "block";
      }
    });
  });

  function renderTeklifler() {
    const container = document.getElementById('tekliflerListesi');
    
    if (filtreliTeklifler.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          üìã Hen√ºz teklif bulunmuyor
        </div>
      `;
      return;
    }

    let html = `
      <div class="list-header">
        <div>M√º≈üteri</div>
		<div>Telefon</div>
        <div>Paket</div>
        <div>Tarih</div>
        <div>Fiyat</div>
        <div>Durum</div>
        <div>ƒ∞≈ülemler</div>
      </div>
    `;

    filtreliTeklifler.forEach(teklif => {
      const tarihFormatli = teklif.tarih ? new Date(teklif.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü';
      const fiyatFormatli = teklif.fiyat ? `${teklif.fiyat} TL` : 'Belirtilmemi≈ü';
      
      html += `
        <div class="list-item">
          <div><strong>${teklif.ad}</strong><br><small>${teklif.yer || 'Yer belirtilmemi≈ü'}</small></div>
		  <div>${teklif.telefon || 'Belirtilmemi≈ü'}</div>
          <div>${teklif.paket || 'Belirtilmemi≈ü'}</div>
          <div>${tarihFormatli}</div>
          <div>${fiyatFormatli}</div>
          <div><span style="color: #ff9800;">‚è≥ Bekliyor</span></div>
          <div class="list-actions">
            <button class="btn-view" onclick="teklifGoster('${teklif.id}')">üëÅÔ∏è</button>
            <button class="btn-edit" onclick="teklifDuzenle('${teklif.id}')">‚úèÔ∏è</button>
            <button class="btn-delete" onclick="teklifSil('${teklif.id}')">üóëÔ∏è</button>
            <button class="btn-contract" onclick="sozlesmeOlustur('${teklif.id}')">üìÑ</button>
            <button class="btn-pdf" onclick="pdfOlustur('${teklif.id}')">üìÑ</button>
            <button class="btn-calendar" onclick="teklifTakvimeEkle('${teklif.id}')">üìÖ</button>

          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function renderSozlesmeler() {
    const container = document.getElementById('sozlesmelerListesi');
    
    if (filtreliSozlesmeler.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          üìÑ Hen√ºz s√∂zle≈üme bulunmuyor
        </div>
      `;
      return;
    }

    let html = `
      <div class="list-header sozlesme">
        <div>M√º≈üteri</div>
		<div>Telefon</div>
        <div>Paket</div>
        <div>Tarih</div>
        <div>Fiyat</div>
        <div>Durum</div>
        <div>ƒ∞≈ülemler</div>
      </div>
    `;

    filtreliSozlesmeler.forEach(sozlesme => {
      const tarihFormatli = sozlesme.tarih ? new Date(sozlesme.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü';
      const fiyatFormatli = sozlesme.fiyat ? `${sozlesme.fiyat} TL` : 'Belirtilmemi≈ü';
      
      html += `
        <div class="list-item">
          <div><strong>${sozlesme.ad}</strong><br><small>${sozlesme.yer || 'Yer belirtilmemi≈ü'}</small></div>
		  <div>${sozlesme.telefon || 'Belirtilmemi≈ü'}</div>
          <div>${sozlesme.paket || 'Belirtilmemi≈ü'}</div>
          <div>${tarihFormatli}</div>
          <div>${fiyatFormatli}</div>
          <div><span style="color: #4caf50;">‚úÖ Aktif</span></div>
          <div class="list-actions">
            <button class="btn-view" onclick="sozlesmeGoster('${sozlesme.id}')">üëÅÔ∏è</button>
            <button class="btn-edit" onclick="sozlesmeDuzenle('${sozlesme.id}')">‚úèÔ∏è</button>
            <button class="btn-delete" onclick="sozlesmeSil('${sozlesme.id}')">üóëÔ∏è</button>
            <button class="btn-pdf" onclick="sozlesmePdfOlustur('${sozlesme.id}')">üìÑ</button>
            <button class="btn-calendar" onclick="sozlesmeTakvimeEkle('${sozlesme.id}')" ${!isCalendarAuthorized ? 'disabled' : ''}>üìÖ</button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // Teklifi takvime ekleme
async function teklifTakvimeEkle(teklifId) {
  const teklif = teklifler.find(t => t.id === teklifId);
  if (!teklif) {
    alert('Teklif bulunamadƒ±!');
    return;
  }

  const event = await addToGoogleCalendar(teklif, 'teklif');

  if (firebaseConnected && event) {
    await db.collection('teklifler').doc(teklifId).update({
      calendarEventId: event.id  // üî• ID'yi kaydet
    });

    // Teklifi yerel listeye de g√ºncelle
    const index = teklifler.findIndex(t => t.id === teklifId);
    if (index !== -1) {
      teklifler[index].calendarEventId = event.id;
    }
  }

  alert('Teklif Google Calendar\'a eklendi!');
}


async function sozlesmeTakvimeEkle(sozlesmeId) {
  const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
  if (!sozlesme) {
    alert('S√∂zle≈üme bulunamadƒ±!');
    return;
  }
  await addToGoogleCalendar(sozlesme, 'sozlesme');
}


  // S√∂zle≈ümeyi takvime ekleme
  async function sozlesmeTakvimeEkle(sozlesmeId) {
  const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
  if (!sozlesme) {
    alert('S√∂zle≈üme bulunamadƒ±!');
    return;
  }

  const calendarEventId = sozlesme.calendarEventId;

  if (!calendarEventId) {
    alert('‚ùå Bu s√∂zle≈ümenin takvimde baƒülƒ± etkinliƒüi bulunamadƒ±.');
    return;
  }

  try {
    const etkinlik = await gapi.client.calendar.events.get({
      calendarId: 'primary',
      eventId: calendarEventId
    });

    const updatedEvent = etkinlik.result;
    updatedEvent.summary = `üìÑ S√ñZLE≈ûME: ${sozlesme.ad}`;
    updatedEvent.description = `
üë§ M√º≈üteri: ${sozlesme.ad}
üìû Telefon: ${sozlesme.telefon || 'Belirtilmemi≈ü'}
üì¶ Paket: ${sozlesme.paket || 'Belirtilmemi≈ü'}
üìç Yer: ${sozlesme.yer || 'Belirtilmemi≈ü'}
üí∞ Fiyat: ${sozlesme.fiyat || 'Belirtilmemi≈ü'} TL
üéØ √áekim T√ºr√º: ${(sozlesme.cekim || '').replace(/<br>/g, '\n')}
üìù A√ßƒ±klama: ${(sozlesme.aciklama || '').replace(/<br>/g, '\n')}
${sozlesme.referans ? `üë§ Referans: ${sozlesme.referans}` : ''}
`.trim();

    updatedEvent.colorId = '11'; // üî¥ Kƒ±rmƒ±zƒ±

    const response = await gapi.client.calendar.events.update({
      calendarId: 'primary',
      eventId: calendarEventId,
      resource: updatedEvent
    });

    console.log('Etkinlik g√ºncellendi:', response.result);
    alert('S√∂zle≈üme takvimde g√ºncellendi ve rengi kƒ±rmƒ±zƒ± yapƒ±ldƒ±!');
  } catch (error) {
    console.error('Takvim g√ºncelleme hatasƒ±:', error);
    alert('Google Calendar g√ºncellenirken hata olu≈ütu: ' + error.message);
  }
}



  // Arama fonksiyonlarƒ±
  function teklifAra() {
    const arama = document.getElementById('teklifArama').value.toLowerCase();
    if (arama.trim() === '') {
      filtreliTeklifler = [...teklifler];
    } else {
      filtreliTeklifler = teklifler.filter(teklif => 
        teklif.ad.toLowerCase().includes(arama) ||
        (teklif.paket && teklif.paket.toLowerCase().includes(arama)) ||
        (teklif.yer && teklif.yer.toLowerCase().includes(arama)) ||
        (teklif.cekim && teklif.cekim.toLowerCase().includes(arama))
      );
    }
    renderTeklifler();
  }

  function sozlesmeAra() {
    const arama = document.getElementById('sozlesmeArama').value.toLowerCase();
    if (arama.trim() === '') {
      filtreliSozlesmeler = [...sozlesmeler];
    } else {
      filtreliSozlesmeler = sozlesmeler.filter(sozlesme => 
        sozlesme.ad.toLowerCase().includes(arama) ||
        (sozlesme.paket && sozlesme.paket.toLowerCase().includes(arama)) ||
        (sozlesme.yer && sozlesme.yer.toLowerCase().includes(arama)) ||
        (sozlesme.cekim && sozlesme.cekim.toLowerCase().includes(arama))
      );
    }
    renderSozlesmeler();
  }

  function aramaTemizle(tip) {
    if (tip === 'teklif') {
      document.getElementById('teklifArama').value = '';
      filtreliTeklifler = [...teklifler];
      renderTeklifler();
    } else {
      document.getElementById('sozlesmeArama').value = '';
      filtreliSozlesmeler = [...sozlesmeler];
      renderSozlesmeler();
    }
  }

  // Enter tu≈üu ile arama
  document.getElementById('teklifArama').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      teklifAra();
    }
  });

  document.getElementById('sozlesmeArama').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sozlesmeAra();
    }
  });

  // Teklif d√ºzenleme
  function teklifDuzenle(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) {
      alert('Teklif bulunamadƒ±!');
      return;
    }

    const output = document.getElementById('output');
    output.innerHTML = `
      <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h3 style="color: #856404; margin-top: 0;">‚úèÔ∏è Teklif D√ºzenle</h3>
        <form id="teklifDuzenleForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üë§ M√º≈üteri Adƒ±:</label>
            <input type="text" id="duzenleAd" value="${teklif.ad}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
          </div>
		  <div>
  <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìû Telefon:</label>
  <input type="text" id="duzenleTelefon" value="${teklif.telefon || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
</div>

          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üì¶ Paket:</label>
            <input type="text" id="duzenlePaket" value="${teklif.paket || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìÖ √áekim Tarihi:</label>
            <input type="date" id="duzenleTarih" value="${teklif.tarih || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üí∞ Fiyat:</label>
            <input type="number" id="duzenleFiyat" value="${teklif.fiyat || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="0">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìç Yer:</label>
            <input type="text" id="duzenleYer" value="${teklif.yer || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üéØ √áekim T√ºr√º:</label>
            <textarea id="duzenleCekim" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${teklif.cekim ? teklif.cekim.replace(/<br>/g, '\n') : ''}</textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìù A√ßƒ±klama:</label>
            <textarea id="duzenleAciklama" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${teklif.aciklama ? teklif.aciklama.replace(/<br>/g, '\n') : ''}</textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üë§ Referans:</label>
            <input type="text" id="duzenleReferans" value="${teklif.referans || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="grid-column: 1 / -1; margin-top: 20px;">
            <button type="button" onclick="teklifGuncelle('${teklif.id}')" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-weight: bold;">üíæ G√ºncelle</button>
            <button type="button" onclick="document.getElementById('output').innerHTML = ''" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">‚ùå ƒ∞ptal</button>
          </div>
        </form>
      </div>
    `;
    output.scrollIntoView({ behavior: 'smooth' });
  }

  // Teklif g√ºncelleme
  async function teklifGuncelle(teklifId) {
    const ad = document.getElementById('duzenleAd').value.trim();
	const telefon = document.getElementById('duzenleTelefon').value.trim();
    const paket = document.getElementById('duzenlePaket').value.trim();
    const tarih = document.getElementById('duzenleTarih').value;
    const fiyat = document.getElementById('duzenleFiyat').value;
    const yer = document.getElementById('duzenleYer').value.trim();
    const cekim = document.getElementById('duzenleCekim').value.trim();
    const aciklama = document.getElementById('duzenleAciklama').value.trim();
    const referans = document.getElementById('duzenleReferans').value.trim();

    if (!ad) {
      alert('M√º≈üteri adƒ± bo≈ü bƒ±rakƒ±lamaz!');
      return;
    }

    const guncellenmisTeklif = {
      ad: ad,
	  telefon: telefon,
      paket: paket,
      tarih: tarih,
      fiyat: fiyat ? parseFloat(fiyat) : null,
      yer: yer,
      cekim: cekim.replace(/\n/g, '<br>'),
      aciklama: aciklama.replace(/\n/g, '<br>'),
      referans: referans,
      updatedAt: new Date()
    };

    try {
      if (firebaseConnected) {
        await db.collection('teklifler').doc(teklifId).update(guncellenmisTeklif);
      }

      // Yerel diziyi g√ºncelle
      const teklifIndex = teklifler.findIndex(t => t.id === teklifId);
      if (teklifIndex !== -1) {
        teklifler[teklifIndex] = { ...teklifler[teklifIndex], ...guncellenmisTeklif };
      }

      const filtreliIndex = filtreliTeklifler.findIndex(t => t.id === teklifId);
      if (filtreliIndex !== -1) {
        filtreliTeklifler[filtreliIndex] = { ...filtreliTeklifler[filtreliIndex], ...guncellenmisTeklif };
      }

      renderTeklifler();
      
      document.getElementById('output').innerHTML = `
        <div style="color: green; padding: 10px; border: 1px solid green; border-radius: 5px;">
          ‚úÖ Teklif ba≈üarƒ±yla g√ºncellendi!
        </div>
      `;
    } catch (error) {
      console.error('G√ºncelleme hatasƒ±:', error);
      alert('Teklif g√ºncellenirken hata olu≈ütu: ' + error.message);
    }
  }

  // Teklif g√∂r√ºnt√ºleme
  function teklifGoster(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) {
      alert('Teklif bulunamadƒ±!');
      return;
    }

    const output = document.getElementById('output');
    output.innerHTML = `
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
        <h3 style="color: #007bff; margin-top: 0;">üìã Teklif Detaylarƒ±</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div><strong>üë§ M√º≈üteri:</strong> ${teklif.ad}</div>
		  <div><strong>üìû Telefon:</strong> ${teklif.telefon || 'Belirtilmemi≈ü'}</div>
          <div><strong>üì¶ Paket:</strong> ${teklif.paket || 'Belirtilmemi≈ü'}</div>
          <div><strong>üìÖ Tarih:</strong> ${teklif.tarih ? new Date(teklif.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü'}</div>
          <div><strong>üí∞ Fiyat:</strong> ${teklif.fiyat ? teklif.fiyat + ' TL' : 'Belirtilmemi≈ü'}</div>
          <div><strong>üìç Yer:</strong> ${teklif.yer || 'Belirtilmemi≈ü'}</div>
          <div><strong>üìù Olu≈üturma:</strong> ${teklif.bugun || 'Belirtilmemi≈ü'}</div>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>üéØ √áekim T√ºr√º:</strong><br>
          <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
            ${teklif.cekim || 'Belirtilmemi≈ü'}
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>üìù A√ßƒ±klama:</strong><br>
          <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
            ${teklif.aciklama || 'Belirtilmemi≈ü'}
          </div>
        </div>
        ${teklif.referans ? `<div><strong>üë§ Referans:</strong> ${teklif.referans}</div>` : ''}
        <div style="margin-top: 20px;">
          <button onclick="pdfOlustur('${teklif.id}')" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">üìÑ PDF Olu≈ütur</button>
          <button onclick="sozlesmeOlustur('${teklif.id}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üìÑ S√∂zle≈ümeye √áevir</button>
        </div>
      </div>
    `;
    output.scrollIntoView({ behavior: 'smooth' });
  }

  // S√∂zle≈üme d√ºzenleme
  function sozlesmeDuzenle(sozlesmeId) {
    const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
    if (!sozlesme) {
      alert('S√∂zle≈üme bulunamadƒ±!');
      return;
    }

    const output = document.getElementById('output');
    output.innerHTML = `
      <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
        <h3 style="color: #721c24; margin-top: 0;">‚úèÔ∏è S√∂zle≈üme D√ºzenle</h3>
        <form id="sozlesmeDuzenleForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üë§ M√º≈üteri Adƒ±:</label>
            <input type="text" id="sozlesmeDuzenleAd" value="${sozlesme.ad}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
          </div>
		  <div>
  <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìû Telefon:</label>
  <input type="text" id="sozlesmeDuzenleTelefon" value="${sozlesme.telefon || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
</div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üì¶ Paket:</label>
            <input type="text" id="sozlesmeDuzenlePaket" value="${sozlesme.paket || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìÖ √áekim Tarihi:</label>
            <input type="date" id="sozlesmeDuzenleTarih" value="${sozlesme.tarih || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üí∞ Fiyat:</label>
            <input type="number" id="sozlesmeDuzenleFiyat" value="${sozlesme.fiyat || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="0">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìç Yer:</label>
            <input type="text" id="sozlesmeDuzenleYer" value="${sozlesme.yer || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üéØ √áekim T√ºr√º:</label>
            <textarea id="sozlesmeDuzenleCekim" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${sozlesme.cekim ? sozlesme.cekim.replace(/<br>/g, '\n') : ''}</textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìù A√ßƒ±klama:</label>
            <textarea id="sozlesmeDuzenleAciklama" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${sozlesme.aciklama ? sozlesme.aciklama.replace(/<br>/g, '\n') : ''}</textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üë§ Referans:</label>
            <input type="text" id="sozlesmeDuzenleReferans" value="${sozlesme.referans || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="grid-column: 1 / -1; margin-top: 20px;">
            <button type="button" onclick="sozlesmeGuncelle('${sozlesme.id}')" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-weight: bold;">üíæ G√ºncelle</button>
            <button type="button" onclick="document.getElementById('output').innerHTML = ''" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">‚ùå ƒ∞ptal</button>
          </div>
        </form>
      </div>
    `;
    output.scrollIntoView({ behavior: 'smooth' });
  }

  // S√∂zle≈üme g√ºncelleme
  async function sozlesmeGuncelle(sozlesmeId) {
    const ad = document.getElementById('sozlesmeDuzenleAd').value.trim();
	const telefon = document.getElementById('sozlesmeDuzenleTelefon').value.trim();
    const paket = document.getElementById('sozlesmeDuzenlePaket').value.trim();
    const tarih = document.getElementById('sozlesmeDuzenleTarih').value;
    const fiyat = document.getElementById('sozlesmeDuzenleFiyat').value;
    const yer = document.getElementById('sozlesmeDuzenleYer').value.trim();
    const cekim = document.getElementById('sozlesmeDuzenleCekim').value.trim();
    const aciklama = document.getElementById('sozlesmeDuzenleAciklama').value.trim();
    const referans = document.getElementById('sozlesmeDuzenleReferans').value.trim();

    if (!ad) {
      alert('M√º≈üteri adƒ± bo≈ü bƒ±rakƒ±lamaz!');
      return;
    }

    const guncellenmisSozlesme = {
      ad: ad,
	  telefon: telefon,
      paket: paket,
      tarih: tarih,
      fiyat: fiyat ? parseFloat(fiyat) : null,
      yer: yer,
      cekim: cekim.replace(/\n/g, '<br>'),
      aciklama: aciklama.replace(/\n/g, '<br>'),
      referans: referans,
      updatedAt: new Date()
    };

    try {
      if (firebaseConnected) {
        await db.collection('sozlesmeler').doc(sozlesmeId).update(guncellenmisSozlesme);
      }

      // Yerel diziyi g√ºncelle
      const sozlesmeIndex = sozlesmeler.findIndex(s => s.id === sozlesmeId);
      if (sozlesmeIndex !== -1) {
        sozlesmeler[sozlesmeIndex] = { ...sozlesmeler[sozlesmeIndex], ...guncellenmisSozlesme };
      }

      const filtreliIndex = filtreliSozlesmeler.findIndex(s => s.id === sozlesmeId);
      if (filtreliIndex !== -1) {
        filtreliSozlesmeler[filtreliIndex] = { ...filtreliSozlesmeler[filtreliIndex], ...guncellenmisSozlesme };
      }

      renderSozlesmeler();
      
      document.getElementById('output').innerHTML = `
        <div style="color: green; padding: 10px; border: 1px solid green; border-radius: 5px;">
          ‚úÖ S√∂zle≈üme ba≈üarƒ±yla g√ºncellendi!
        </div>
      `;
    } catch (error) {
      console.error('G√ºncelleme hatasƒ±:', error);
      alert('S√∂zle≈üme g√ºncellenirken hata olu≈ütu: ' + error.message);
    }
  }

  // S√∂zle≈üme g√∂r√ºnt√ºleme
  function sozlesmeGoster(sozlesmeId) {
    const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
    if (!sozlesme) {
      alert('S√∂zle≈üme bulunamadƒ±!');
      return;
    }

    const output = document.getElementById('output');
    output.innerHTML = `
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
        <h3 style="color: #dc3545; margin-top: 0;">üìÑ S√∂zle≈üme Detaylarƒ±</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div><strong>üë§ M√º≈üteri:</strong> ${sozlesme.ad}</div>
		  <div><strong>üìû Telefon:</strong> ${sozlesme.telefon || 'Belirtilmemi≈ü'}</div>
          <div><strong>üì¶ Paket:</strong> ${sozlesme.paket || 'Belirtilmemi≈ü'}</div>
          <div><strong>üìÖ Tarih:</strong> ${sozlesme.tarih ? new Date(sozlesme.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü'}</div>
          <div><strong>üí∞ Fiyat:</strong> ${sozlesme.fiyat ? sozlesme.fiyat + ' TL' : 'Belirtilmemi≈ü'}</div>
          <div><strong>üìç Yer:</strong> ${sozlesme.yer || 'Belirtilmemi≈ü'}</div>
          <div><strong>üìù S√∂zle≈üme Tarihi:</strong> ${sozlesme.sozlesmeTarihi || 'Belirtilmemi≈ü'}</div>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>üéØ √áekim T√ºr√º:</strong><br>
          <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
            ${sozlesme.cekim || 'Belirtilmemi≈ü'}
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>üìù A√ßƒ±klama:</strong><br>
          <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
            ${sozlesme.aciklama || 'Belirtilmemi≈ü'}
          </div>
        </div>
        ${sozlesme.referans ? `<div><strong>üë§ Referans:</strong> ${sozlesme.referans}</div>` : ''}
        <div style="margin-top: 20px;">
          <button onclick="sozlesmePdfOlustur('${sozlesme.id}')" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üìÑ PDF Olu≈ütur</button>
        </div>
      </div>
    `;
    output.scrollIntoView({ behavior: 'smooth' });
  }

  // Teklif silme
  async function teklifSil(teklifId) {
    if (!confirm('Bu teklifi silmek istediƒüinizden emin misiniz?')) {
      return;
    }

    try {
      if (firebaseConnected) {
        await db.collection('teklifler').doc(teklifId).delete();
      }
      
      teklifler = teklifler.filter(t => t.id !== teklifId);
      filtreliTeklifler = filtreliTeklifler.filter(t => t.id !== teklifId);
      renderTeklifler();
      
      document.getElementById('output').innerHTML = `
        <div style="color: green; padding: 10px; border: 1px solid green; border-radius: 5px;">
          ‚úÖ Teklif ba≈üarƒ±yla silindi.
        </div>
      `;
    } catch (error) {
      console.error('Silme hatasƒ±:', error);
      alert('Teklif silinirken hata olu≈ütu: ' + error.message);
    }
  }

  // S√∂zle≈üme silme
  async function sozlesmeSil(sozlesmeId) {
    if (!confirm('Bu s√∂zle≈ümeyi silmek istediƒüinizden emin misiniz?')) {
      return;
    }

    try {
      if (firebaseConnected) {
        await db.collection('sozlesmeler').doc(sozlesmeId).delete();
      }
      
      sozlesmeler = sozlesmeler.filter(s => s.id !== sozlesmeId);
      filtreliSozlesmeler = filtreliSozlesmeler.filter(s => s.id !== sozlesmeId);
      renderSozlesmeler();
      
      document.getElementById('output').innerHTML = `
        <div style="color: green; padding: 10px; border: 1px solid green; border-radius: 5px;">
          ‚úÖ S√∂zle≈üme ba≈üarƒ±yla silindi.
        </div>
      `;
    } catch (error) {
      console.error('Silme hatasƒ±:', error);
      alert('S√∂zle≈üme silinirken hata olu≈ütu: ' + error.message);
    }
  }

  // Teklifi s√∂zle≈ümeye √ßevirme
  async function sozlesmeOlustur(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) {
      alert('Teklif bulunamadƒ±!');
      return;
    }
	console.log("S√∂zle≈ümeye √ßevrilecek teklif:", teklif);

    if (!confirm('Bu teklifi s√∂zle≈ümeye √ßevirmek istediƒüinizden emin misiniz?')) {
      return;
    }

    try {
const sozlesmeVerisi = {
  ...teklif,
  sozlesmeTarihi: new Date().toLocaleDateString('tr-TR'),
  createdAt: teklif.createdAt ? teklif.createdAt : new Date(),
  tip: 'sozlesme',
  calendarEventId: teklif.calendarEventId || null  // üî• Etkinlik ID'sini s√∂zle≈ümeye aktar
};

      
      delete sozlesmeVerisi.id; // Eski ID'yi kaldƒ±r

      if (firebaseConnected) {
        const docRef = await db.collection('sozlesmeler').add(sozlesmeVerisi);
        sozlesmeVerisi.id = docRef.id;
        
        // Teklifi sil
        await db.collection('teklifler').doc(teklifId).delete();
      } else {
        sozlesmeVerisi.id = 'sozlesme_' + Date.now();
      }

      // Yerel dizileri g√ºncelle
      sozlesmeler.unshift(sozlesmeVerisi);
      filtreliSozlesmeler.unshift(sozlesmeVerisi);
      
      teklifler = teklifler.filter(t => t.id !== teklifId);
      filtreliTeklifler = filtreliTeklifler.filter(t => t.id !== teklifId);
      
      renderTeklifler();
      renderSozlesmeler();
      
      document.getElementById('output').innerHTML = `
        <div style="color: green; padding: 10px; border: 1px solid green; border-radius: 5px;">
          ‚úÖ Teklif ba≈üarƒ±yla s√∂zle≈ümeye √ßevrildi!
        </div>
      `;
    } catch (error) {
      console.error('S√∂zle≈üme olu≈üturma hatasƒ±:', error);
      alert('S√∂zle≈üme olu≈üturulurken hata olu≈ütu: ' + error.message);
    }
  }

  // PDF olu≈üturma fonksiyonlarƒ±
  function pdfOlustur(teklifId) {
    const teklif = teklifler.find(t => t.id === teklifId);
    if (!teklif) {
      alert('Teklif bulunamadƒ±!');
      return;
    }

    const pdfContent = document.getElementById('pdfContent');
    pdfContent.innerHTML = `
      <div class="pdf-header">
        <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
        <h1 class="pdf-title">TEKLƒ∞F FORMU</h1>
      </div>
      <div class="pdf-body">
        <p><strong>M√º≈üteri Adƒ±:</strong> ${teklif.ad}</p>
        <p><strong>Paket:</strong> ${teklif.paket || 'Belirtilmemi≈ü'}</p>
        <p><strong>√áekim Tarihi:</strong> ${teklif.tarih ? new Date(teklif.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü'}</p>
        <p><strong>Yer:</strong> ${teklif.yer || 'Belirtilmemi≈ü'}</p>
        <p><strong>Fiyat:</strong> ${teklif.fiyat ? teklif.fiyat + ' TL' : 'Belirtilmemi≈ü'}</p>
        <p><strong>√áekim T√ºr√º:</strong></p>
        <div style="margin-left: 20px; margin-bottom: 15px;">
          ${teklif.cekim ? teklif.cekim.replace(/<br>/g, '<br>') : 'Belirtilmemi≈ü'}
        </div>
        <p><strong>A√ßƒ±klama:</strong></p>
        <div style="margin-left: 20px; margin-bottom: 15px;">
          ${teklif.aciklama ? teklif.aciklama.replace(/\n/g, '<br>') : 'Belirtilmemi≈ü'}
        </div>
        ${teklif.referans ? `<p><strong>Referans:</strong> ${teklif.referans}</p>` : ''}
      </div>
      <div class="pdf-footer">
        <p>Teklif Tarihi: ${teklif.bugun || new Date().toLocaleDateString('tr-TR')}</p>
        <p>Bu teklif 30 g√ºn ge√ßerlidir.</p>
      </div>
    `;
    
    pdfContent.style.display = 'block';
    window.print();
    pdfContent.style.display = 'none';
  }

  function sozlesmePdfOlustur(sozlesmeId) {
    const sozlesme = sozlesmeler.find(s => s.id === sozlesmeId);
    if (!sozlesme) {
      alert('S√∂zle≈üme bulunamadƒ±!');
      return;
    }

    const pdfContent = document.getElementById('pdfContent');
    pdfContent.innerHTML = `
      <div class="pdf-header">
        <img src="https://i.hizliresim.com/eqyhuxx.png" alt="Logo" />
        <h1 class="pdf-title">S√ñZLE≈ûME</h1>
      </div>
      <div class="pdf-body">
        <p><strong>M√º≈üteri Adƒ±:</strong> ${sozlesme.ad}</p>
        <p><strong>Paket:</strong> ${sozlesme.paket || 'Belirtilmemi≈ü'}</p>
        <p><strong>√áekim Tarihi:</strong> ${sozlesme.tarih ? new Date(sozlesme.tarih).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü'}</p>
        <p><strong>Yer:</strong> ${sozlesme.yer || 'Belirtilmemi≈ü'}</p>
        <p><strong>Fiyat:</strong> ${sozlesme.fiyat ? sozlesme.fiyat + ' TL' : 'Belirtilmemi≈ü'}</p>
        <p><strong>√áekim T√ºr√º:</strong></p>
        <div style="margin-left: 20px; margin-bottom: 15px;">
          ${sozlesme.cekim ? sozlesme.cekim.replace(/<br>/g, '<br>') : 'Belirtilmemi≈ü'}
        </div>
        <p><strong>≈ûartlar ve Ko≈üullar:</strong></p>
        <div style="margin-left: 20px; margin-bottom: 15px;">
          ${sozlesme.aciklama ? sozlesme.aciklama.replace(/\n/g, '<br>') : 'Belirtilmemi≈ü'}
        </div>
        ${sozlesme.referans ? `<p><strong>Referans:</strong> ${sozlesme.referans}</p>` : ''}
      </div>
      <div class="pdf-footer">
        <p>S√∂zle≈üme Tarihi: ${sozlesme.sozlesmeTarihi || new Date().toLocaleDateString('tr-TR')}</p>
        <p>Bu s√∂zle≈üme yasal olarak baƒülayƒ±cƒ±dƒ±r.</p>
        <div style="margin-top: 40px; display: flex; justify-content: space-between;">
          <div style="text-align: center;">
            <div style="border-top: 1px solid #333; width: 200px; margin-top: 60px;">M√º≈üteri ƒ∞mzasƒ±</div>
          </div>
          <div style="text-align: center;">
            <div style="border-top: 1px solid #333; width: 200px; margin-top: 60px;">Firma ƒ∞mzasƒ±</div>
          </div>
        </div>
      </div>
    `;
    
    pdfContent.style.display = 'block';
    window.print();
    pdfContent.style.display = 'none';
  }
</script>

</body>
</html>
